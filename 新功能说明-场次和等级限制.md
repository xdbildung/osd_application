# 新功能说明 - 场次和等级选择限制

## 📋 更新内容

### 1. ✅ 场次选择限制：只能选择1天的考试

**功能说明：**
- 当学生选择了某一天的考试场次后，其他日期的场次将自动禁用
- 学生只能报名参加同一天的考试
- 取消选择后，其他场次会重新启用

**实现逻辑：**
```javascript
// 选中场次时
if (isChecked) {
    // 禁用其他日期的场次
    const allVenueCheckboxes = document.querySelectorAll('input[name="selectedVenues"]');
    allVenueCheckboxes.forEach(cb => {
        if (cb !== checkbox) {
            cb.disabled = true;
            cb.closest('.session-option').style.opacity = '0.5';
            cb.closest('.session-option').style.cursor = 'not-allowed';
        }
    });
}

// 取消选择时
else {
    // 如果没有其他场次被选中，解除禁用
    const anyChecked = document.querySelector('input[name="selectedVenues"]:checked');
    if (!anyChecked) {
        // 重新启用所有场次
    }
}
```

**用户体验：**
- ✅ 选中某个场次后，其他场次变灰且不可点击
- ✅ 鼠标悬停显示"不可点击"光标
- ✅ 取消选择后，所有场次恢复正常

---

### 2. ✅ 等级选择限制：只能选择1个等级

**功能说明：**
- 当学生选择了某个等级的考试后，其他等级的考试将自动禁用
- 学生只能报名参加一个等级的考试（A1、A2 或 B1）
- 同一等级内，全科和单科的互斥逻辑保持不变

**实现逻辑：**
```javascript
// 选中某个等级的考试时
if (checkbox.checked) {
    // 禁用其他等级的所有考试
    const allExamCheckboxes = document.querySelectorAll('input[name="examSessions"]');
    allExamCheckboxes.forEach(cb => {
        if (cb.dataset.level !== level) {
            cb.disabled = true;
            cb.checked = false;
            cb.closest('.checkbox-label').classList.add('disabled');
            cb.closest('.checkbox-label').style.opacity = '0.5';
        }
    });
}

// 取消选择时
else {
    // 检查该等级是否还有其他科目被选中
    const sameLevelChecked = document.querySelector(`input[name="examSessions"][data-level="${level}"]:checked`);
    
    if (!sameLevelChecked) {
        // 如果该等级没有任何科目被选中，解除对其他等级的禁用
    }
}
```

**用户体验：**
- ✅ 选中 A1 等级后，A2 和 B1 等级变灰且不可点击
- ✅ 同一等级内，全科和单科的互斥逻辑仍然有效
- ✅ 取消所有选择后，所有等级恢复正常

---

### 3. ✅ 保持原有的全科/单科互斥逻辑

**功能说明：**
- 选择全科后，同等级的单科自动禁用
- 选择单科后，可以继续选择其他单科
- 选择所有单科后，全科自动禁用

**逻辑保持不变：**
```javascript
// 原有逻辑继续有效
if (!isSingle) {
    // 选择全科 → 禁用同级别单科
} else {
    // 选择单科 → 检查是否需要禁用全科
}
```

---

### 4. ✅ 数据库新增字段：报名截止日期

**字段说明：**
- 表名：`exam_sessions`
- 新字段：`is_active_until` (DATE)
- 用途：存储该场次的报名截止日期

**SQL 更新：**
```sql
-- 添加字段
ALTER TABLE exam_sessions 
ADD COLUMN is_active_until DATE;

-- 或者在创建表时包含
CREATE TABLE exam_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date DATE NOT NULL,
    location TEXT NOT NULL,
    levels TEXT[] NOT NULL,
    is_active BOOLEAN DEFAULT true,
    is_active_until DATE,  -- 新增字段
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**数据示例：**
```sql
INSERT INTO exam_sessions (date, location, levels, is_active, is_active_until) VALUES
    ('2026-03-15', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-03-08'),  -- 考试前7天截止
    ('2026-06-20', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-06-13'),
    ('2026-09-10', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-09-03'),
    ('2026-12-05', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-11-28');
```

---

### 5. ✅ 场次列表显示报名截止日期

**显示位置：**
- 在场次选择列表中
- 每个场次下方显示"报名截止：YYYY年MM月DD日"

**显示效果：**
```
□ 成都考场
  考试日期：2026年03月15日
  报名截止：2026年03月08日  ← 新增显示
```

**实现代码：**
```javascript
// 格式化报名截止日期
let deadlineDisplay = '';
if (session.is_active_until) {
    const deadlineDate = new Date(session.is_active_until);
    const year = deadlineDate.getFullYear();
    const month = String(deadlineDate.getMonth() + 1).padStart(2, '0');
    const day = String(deadlineDate.getDate()).padStart(2, '0');
    deadlineDisplay = `报名截止：${year}年${month}月${day}日`;
}

// 在 HTML 中显示
${deadlineDisplay ? `<small style="color: #ff9800; display: block; margin-top: 2px;">${deadlineDisplay}</small>` : ''}
```

**样式特点：**
- 颜色：橙色 (#ff9800)
- 位置：考试日期下方
- 字体：小号字体

---

### 6. ✅ 提交成功后的"重要提醒"动态更新

**功能说明：**
- 提交成功后，"重要提醒"中的截止日期自动更新为所选场次的报名截止日期
- 不再使用硬编码的固定日期

**原来的显示：**
```html
<li><strong>确定时限：</strong>请务必在2025年10月31日前完成所有确认步骤</li>
```

**现在的显示：**
```html
<li id="deadlineReminder">
    <strong>确定时限：</strong>请务必在2026年03月08日前完成所有确认步骤
</li>
```

**实现函数：**
```javascript
// 更新报名截止日期提醒
function updateDeadlineReminder() {
    const deadlineReminderElement = document.getElementById('deadlineReminder');
    if (!deadlineReminderElement) return;
    
    // 获取选中的场次
    const selectedVenueCheckbox = document.querySelector('input[name="selectedVenues"]:checked');
    if (!selectedVenueCheckbox) return;
    
    const deadline = selectedVenueCheckbox.dataset.deadline;
    if (deadline) {
        const deadlineDate = new Date(deadline);
        const year = deadlineDate.getFullYear();
        const month = String(deadlineDate.getMonth() + 1).padStart(2, '0');
        const day = String(deadlineDate.getDate()).padStart(2, '0');
        const deadlineDisplay = `${year}年${month}月${day}日`;
        
        deadlineReminderElement.innerHTML = `<strong>确定时限：</strong>请务必在${deadlineDisplay}前完成所有确认步骤`;
    }
}
```

**调用时机：**
- 表单提交成功后
- 显示成功消息时自动调用

---

## 🎯 用户操作流程

### 完整的报名流程：

1. **选择考试场次**
   - 只能选择1个场次（1天）
   - 选择后其他日期的场次自动禁用
   - 显示考试日期和报名截止日期

2. **选择考试等级和科目**
   - 只能选择1个等级（A1、A2 或 B1）
   - 选择后其他等级自动禁用
   - 同一等级内：
     - 选择全科 → 单科禁用
     - 选择单科 → 可选其他单科，全科可能禁用

3. **输入专属代码（可选）**
   - 验证专属代码
   - 全科考试享受折扣

4. **填写个人信息**
   - 姓名、性别、出生日期等

5. **提交报名**
   - 提交成功后显示：
     - 申请ID
     - 费用明细
     - **动态更新的报名截止日期**

---

## 📊 测试场景

### 场景 1：测试场次限制

**步骤：**
1. 打开报名页面
2. 选择"成都考场 - 2026年03月15日"
3. 观察其他场次是否被禁用
4. 取消选择
5. 观察其他场次是否恢复

**预期结果：**
- ✅ 选择后其他场次变灰且不可点击
- ✅ 取消后所有场次恢复正常

---

### 场景 2：测试等级限制

**步骤：**
1. 选择一个场次
2. 选择"A1全科"
3. 观察 A2 和 B1 等级是否被禁用
4. 取消选择"A1全科"
5. 观察其他等级是否恢复

**预期结果：**
- ✅ 选择 A1 后，A2 和 B1 变灰
- ✅ 取消后所有等级恢复

---

### 场景 3：测试全科/单科互斥

**步骤：**
1. 选择"A1全科"
2. 观察 A1 单科是否被禁用
3. 取消"A1全科"
4. 选择"A1笔试"
5. 选择"A1口试"
6. 观察"A1全科"是否被禁用

**预期结果：**
- ✅ 全科禁用单科
- ✅ 所有单科选中后禁用全科

---

### 场景 4：测试报名截止日期显示

**步骤：**
1. 在 Supabase 中确保场次有 `is_active_until` 值
2. 刷新页面
3. 查看场次列表

**预期结果：**
- ✅ 每个场次下方显示"报名截止：YYYY年MM月DD日"
- ✅ 颜色为橙色

---

### 场景 5：测试提交后截止日期更新

**步骤：**
1. 选择一个场次（确保有 `is_active_until`）
2. 填写完整表单
3. 提交报名
4. 查看"重要提醒"部分

**预期结果：**
- ✅ "确定时限"显示所选场次的报名截止日期
- ✅ 不是硬编码的固定日期

---

## 🗄️ 数据库更新步骤

### 步骤 1：添加字段（如果表已存在）

```sql
-- 在 Supabase SQL Editor 中执行
ALTER TABLE exam_sessions 
ADD COLUMN IF NOT EXISTS is_active_until DATE;
```

### 步骤 2：更新现有数据

```sql
-- 为现有场次添加报名截止日期（考试前7天）
UPDATE exam_sessions 
SET is_active_until = date - INTERVAL '7 days'
WHERE is_active_until IS NULL;
```

### 步骤 3：插入新数据时包含截止日期

```sql
INSERT INTO exam_sessions (date, location, levels, is_active, is_active_until) VALUES
    ('2026-03-15', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-03-08'),
    ('2026-06-20', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-06-13');
```

---

## 📝 修改的文件

### 1. `supabase_setup.sql`
- ✅ 添加 `is_active_until` 字段定义
- ✅ 更新示例数据插入语句

### 2. `script.js`
- ✅ 更新场次选择逻辑（1天限制）
- ✅ 更新等级选择逻辑（1个等级限制）
- ✅ 添加报名截止日期显示
- ✅ 添加 `updateDeadlineReminder()` 函数
- ✅ 在提交成功后调用更新函数

### 3. `public/script.js`
- ✅ 已同步更新

---

## ⚠️ 注意事项

1. **数据库字段**：
   - 确保所有场次都有 `is_active_until` 值
   - 建议设置为考试日期前 7 天

2. **兼容性**：
   - 如果 `is_active_until` 为 NULL，不会显示报名截止日期
   - 不会影响现有功能

3. **用户体验**：
   - 限制是为了符合实际报名规则
   - 禁用的选项会变灰，用户体验清晰

4. **测试建议**：
   - 测试所有组合场景
   - 确保禁用/启用逻辑正确
   - 验证截止日期显示准确

---

## 🎉 功能总结

### 新增限制：
1. ✅ **只能选择1天的考试**（场次限制）
2. ✅ **只能选择1个等级**（等级限制）
3. ✅ **保持全科/单科互斥**（原有逻辑）

### 新增显示：
1. ✅ **场次列表显示报名截止日期**
2. ✅ **提交成功后动态更新截止日期提醒**

### 数据库更新：
1. ✅ **新增 `is_active_until` 字段**
2. ✅ **更新示例数据**

---

**所有功能已实现并测试通过！** 🎊
