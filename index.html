<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奥德考试报名表</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>奥德考试报名表</h1>
        <p class="description">
            亲爱的同学们，欢迎报名参加慕尼黑SDI语言大学举办的奥德考试！✨
        </p>
        
        <form id="registrationForm">
            <div class="form-group">
                <label for="signedDocument">签字文件上传 <span class="required">*</span></label>
                <div class="file-upload-container">
                    <div class="file-download-section">
                        <p class="file-instruction">【温馨提示】 请先下载、填写并签字扫描《考试须知》，再填写申请表，避免中途退出导致已填信息丢失。</p>
                        <a href="/SDI_exam_notification.pdf" class="download-btn" download="SDI_exam_notification.pdf">
                            📄 点击下载：《考试须知》文件
                        </a>
                        <div class="wechat-download-tip" style="
                            background: #f8f9fa;
                            border-left: 3px solid #6c757d;
                            padding: 12px;
                            margin-top: 12px;
                            border-radius: 4px;
                            font-size: 13px;
                            color: #6c757d;
                            line-height: 1.5;
                        ">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">
                                💡 微信下载问题解决方案
                            </div>
                            <div style="margin-bottom: 8px;">
                                下载时微信提示文件大小为0B且无法转发？此为微信内置错误。
                            </div>
                            <div style="font-weight: 500; margin-bottom: 6px; color: #495057;">
                                解决办法：
                            </div>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>点击下载按钮后，选择"更多打开方式" > 选择 <strong>腾讯文档</strong> 或 <strong>金山文档</strong> 打开下载《考试须知》。</li>
                                <li>点击下载按钮后，选择"用其他应用打开" > 选择 <strong>"保存到文件"</strong> 打开下载《考试须知》。</li>
                            </ol>
                        </div>
                    </div>
                    <div class="file-upload-section">
                        <!-- 移动端优化的上传选项 -->
                        <div class="mobile-upload-options">
                            <div class="upload-option-group">
                                <button type="button" class="upload-option-btn" id="galleryBtn">
                                    📎 上传签字文件或照片
                                </button>
                            </div>
                        </div>
                        <!-- 隐藏的文件输入 -->
                        <input type="file" id="signedDocument" name="signedDocument" accept=".jpg,.jpeg,.png,.pdf" required style="display: none;">
                        <input type="file" id="signedDocumentCamera" name="signedDocumentCamera" accept="image/*" capture="environment" style="display: none;">
                        <input type="file" id="signedDocumentGallery" name="signedDocumentGallery" accept="image/*" style="display: none;">
                        
                        <!-- 传统的文件上传标签（在移动端隐藏） -->
                        <label for="signedDocument" class="file-upload-label traditional-upload">
                            📎 选择已签字的文件（支持JPG、PNG、PDF）
                        </label>
                        <div class="file-info" id="fileInfo"></div>
                    </div>
                </div>
                <div class="error-hint" id="signedDocument-error"></div>
            </div>

            <div class="form-group">
                <label for="firstName">名字（拼音） <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" required>
                <div class="error-hint" id="firstName-error"></div>
            </div>

            <div class="form-group">
                <label for="lastName">姓氏（拼音） <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" required>
                <div class="error-hint" id="lastName-error"></div>
            </div>

            <div class="form-group">
                <label for="gender">性别 <span class="required">*</span></label>
                <select id="gender" name="gender" required>
                    <option value="">请选择...</option>
                    <option value="male">男</option>
                    <option value="female">女</option>
                </select>
                <div class="error-hint" id="gender-error"></div>
            </div>

            <div class="form-group">
                <label for="birthDate">出生日期 <span class="required">*</span></label>
                <input type="date" id="birthDate" name="birthDate" required>
                <div class="error-hint" id="birthDate-error"></div>
            </div>

            <div class="form-group">
                <label for="nationality">国籍 <span class="required">*</span></label>
                <select id="nationality" name="nationality" required>
                    <option value="">请选择...</option>
                    <option value="China">中国</option>
                    <option value="Other">其他</option>
                </select>
                <div class="error-hint" id="nationality-error"></div>
            </div>

            <div class="form-group" id="otherNationalityGroup" style="display: none;">
                <label for="otherNationality">请填写具体国籍（英文） <span class="required">*</span></label>
                <input type="text" id="otherNationality" name="otherNationality" placeholder="例如：United States">
                <div class="error-hint" id="otherNationality-error"></div>
            </div>

            <div class="form-group">
                <label for="birthPlace">出生地（拼音，请与护照保持一致） <span class="required">*</span></label>
                <input type="text" id="birthPlace" name="birthPlace" required>
                <div class="error-hint" id="birthPlace-error"></div>
            </div>

            <div class="form-group">
                <label for="email">邮箱地址 <span class="required">*</span></label>
                <input type="email" id="email" name="email" required>
                <div class="form-note">
                    📧 <strong>重要提醒：</strong>报名成功通知将通过邮件发送，请确保邮箱地址准确无误。如果在报名付费后一天内没有收到邮件，请联系 <a href="mailto:info@sdi-osd.de">info@sdi-osd.de</a>
                </div>
                <div class="error-hint" id="email-error"></div>
            </div>

            <div class="form-group">
                <label for="phoneNumber">联系电话 <span class="required">*</span></label>
                <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="请输入8位座机号或11位手机号">
                <div class="error-hint" id="phoneNumber-error"></div>
            </div>

            <div class="form-group">
                <label for="firstTimeExam">是否为第一次参加该等级考试 <span class="required">*</span></label>
                <select id="firstTimeExam" name="firstTimeExam" required>
                    <option value="">请选择...</option>
                    <option value="Yes">是</option>
                    <option value="No">否</option>
                </select>
                <div class="error-hint" id="firstTimeExam-error"></div>
            </div>

            <div class="form-group">
                <label for="passportNumber">护照号码（有效期须至少六个月；若暂无护照，可留空）</label>
                <input type="text" id="passportNumber" name="passportNumber" placeholder="请输入护照号码或留空">
                <div class="error-hint" id="passportNumber-error"></div>
            </div>

            <div class="form-group">
                <label for="passportUpload">上传护照信息页（如有）</label>
                <div class="file-upload-container">
                    <input type="file" id="passportUpload" name="passportUpload" accept=".jpg,.jpeg,.png,.pdf">
                    <label for="passportUpload" class="file-upload-label">
                        📎 选择护照信息页文件
                    </label>
                    <div class="file-info" id="passportFileInfo"></div>
                </div>
                <div class="form-note">
                    💡 支持JPG、PNG、PDF格式，文件大小不超过5MB<br>
                    🔧 大文件将自动压缩为JPG格式（小于1MB）
                </div>
            </div>

            <div class="form-group">
                <label>报名考试场次 <span class="required">*</span></label>
                <div class="session-selection">
                    <label class="session-option">
                        <input type="checkbox" name="selectedVenues" value="北京" data-venue="北京" data-date="2025年9月6日">
                        <span class="session-info">
                            <strong>北京考场</strong>
                            <small>2025年9月6日</small>
                        </span>
                    </label>
                    <label class="session-option">
                        <input type="checkbox" name="selectedVenues" value="成都" data-venue="成都" data-date="2025年8月27日">
                        <span class="session-info">
                            <strong>成都考场</strong>
                            <small>2025年8月27日</small>
                        </span>
                    </label>
                </div>
                <div class="form-note">
                    💡 您可以同时选择多个考场参加不同等级的考试
                </div>
                <div class="error-hint" id="selectedVenues-error"></div>
            </div>

            <!-- 北京考场选项 -->
            <div class="form-group venue-options" id="beijingOptions" style="display: none;">
                <label>北京考场 - 2025年9月6日 考试选项</label>
                <div class="exam-venue-container">
                    <div class="level-section">
                        <h4>A1等级</h4>
                        <div class="exam-type-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="examSessions" value="北京-A1-全科" data-level="A1" data-location="北京">
                                <span>A1全科</span>
                            </label>
                            <div class="single-modules" style="margin-left: 20px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="北京-A1-笔试" data-level="A1" data-location="北京" data-single="true">
                                    <span>A1笔试</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="北京-A1-口试" data-level="A1" data-location="北京" data-single="true">
                                    <span>A1口试</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="level-section">
                        <h4>A2等级</h4>
                        <div class="exam-type-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="examSessions" value="北京-A2-全科" data-level="A2" data-location="北京">
                                <span>A2全科</span>
                            </label>
                            <div class="single-modules" style="margin-left: 20px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="北京-A2-笔试" data-level="A2" data-location="北京" data-single="true">
                                    <span>A2笔试</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="北京-A2-口试" data-level="A2" data-location="北京" data-single="true">
                                    <span>A2口试</span>
                                </label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="form-note">
                    💡 选择全科后，同等级的单科选项将自动禁用
                </div>
            </div>

            <!-- 成都考场选项 -->
            <div class="form-group venue-options" id="chengduOptions" style="display: none;">
                <label>成都考场 - 2025年8月27日 考试选项</label>
                <div class="exam-venue-container">
                    <div class="level-section">
                        <h4>A1等级</h4>
                        <div class="exam-type-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="examSessions" value="成都-A1-全科" data-level="A1" data-location="成都">
                                <span>A1全科</span>
                            </label>
                            <div class="single-modules" style="margin-left: 20px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="成都-A1-笔试" data-level="A1" data-location="成都" data-single="true">
                                    <span>A1笔试</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="成都-A1-口试" data-level="A1" data-location="成都" data-single="true">
                                    <span>A1口试</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="level-section">
                        <h4>A2等级</h4>
                        <div class="exam-type-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="examSessions" value="成都-A2-全科" data-level="A2" data-location="成都">
                                <span>A2全科</span>
                            </label>
                            <div class="single-modules" style="margin-left: 20px;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="成都-A2-笔试" data-level="A2" data-location="成都" data-single="true">
                                    <span>A2笔试</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="examSessions" value="成都-A2-口试" data-level="A2" data-location="成都" data-single="true">
                                    <span>A2口试</span>
                                </label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="form-note">
                    💡 选择全科后，同等级的单科选项将自动禁用
                </div>
            </div>

            <button type="submit" class="submit-btn">提交报名申请</button>
        </form>

        <div id="successMessage" class="success-message hidden">
            <h2>报名申请提交成功！🎉</h2>
            <p>感谢您的报名！我们已收到您的申请。</p>
            
            <!-- 申请ID显示区域 -->
            <div class="application-id-section">
                <h3>📋 您的申请编号</h3>
                <div class="application-id">
                    <span class="id-label">申请编号：</span>
                    <span class="id-value" id="applicationIdDisplay">---</span>
                </div>
                <div class="id-note">
                    💡 请记录此编号，付费时请在备注中包含此编号，便于我们核对您的付费信息
                </div>
            </div>
            
            <p><strong>接下来请完成缴费并上传付费凭证，完成整个报名流程。</strong></p>
            
            <!-- 付费信息区域 -->
            <div class="payment-section">
                <h3>💰 缴费信息</h3>
                <div class="payment-content">
                    <!-- 1. 考试费用模块 -->
                    <div class="payment-module fee-module">
                        <h4>考试费用（人民币）</h4>
                        <div class="fee-info">
                            <div class="fee-level">
                                <strong>A1等级：</strong>
                                <span>全科 1550元 | 笔试 950元 | 口试 600元</span>
                            </div>
                            <div class="fee-level">
                                <strong>A2等级：</strong>
                                <span>全科 1650元 | 笔试 1000元 | 口试 650元</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. 支付宝扫码模块 -->
                    <div class="payment-module qr-module">
                        <h4>支付宝扫码支付</h4>
                        <div class="qr-container">
                            <img src="/payment_QR_example.png" alt="收款二维码" class="qr-code">
                            <p class="qr-caption">扫码支付</p>
                        </div>
                    </div>
                    
                    <!-- 3. 银行转账模块 -->
                    <div class="payment-module bank-module">
                        <h4>银行转账信息</h4>
                        <div class="bank-info">
                            <div class="bank-item">
                                <span class="label">账户名称：</span>
                                <span class="value">成都学德教育科技有限公司</span>
                            </div>
                            <div class="bank-item">
                                <span class="label">账户号码：</span>
                                <span class="value">161430801</span>
                            </div>
                            <div class="bank-item">
                                <span class="label">收款银行：</span>
                                <span class="value">中国民生银行股份有限公司成都永丰支行</span>
                            </div>
                            <div class="bank-item important">
                                <span class="label">付款附言：</span>
                                <span class="value">请备注：申请编号<br>
                                    <small>（例如：<span id="paymentNoteExample">OSD-0106-001</span> ）</small>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 4. 应付总额模块 -->
                    <div class="payment-module total-module">
                        <div id="totalAmount" class="total-amount">
                            <div class="amount-label">应付总额</div>
                            <div class="amount-value">¥ <span id="totalAmountValue">0</span></div>
                            <div class="amount-note">请按此金额支付</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 上传付费凭证区域 -->
            <div class="payment-upload-section">
                <h3>📋 上传付费凭证</h3>
                <p class="upload-instruction">请上传您的付费凭证（银行转账截图或支付宝/微信支付截图）</p>
                
                <div class="file-upload-container">
                    <input type="file" id="paymentProof" name="paymentProof" accept=".jpg,.jpeg,.png,.pdf" required>
                    <label for="paymentProof" class="file-upload-label">
                        📎 选择付费凭证文件
                    </label>
                    <div class="file-info" id="paymentProofInfo"></div>
                </div>
                
                <div class="form-note">
                    💡 支持JPG、PNG、PDF格式，文件大小不超过5MB<br>
                </div>
                
                <button type="button" id="uploadPaymentProof" class="upload-btn">
                    完成缴费确认
                </button>
            </div>
            

        </div>
    </div>

    <!-- 版本信息页脚 -->
    <footer class="version-footer">
        <div class="version-info">
            <span class="version-text">奥德考试报名系统 v1.6.9</span>
            <span class="copyright">© 2025 慕尼黑SDI语言大学</span>
        </div>
    </footer>

    <!-- PDF.js库用于PDF转换功能 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // 配置PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            console.log('📚 PDF.js库加载成功，支持PDF转JPG功能');
        }
    </script>
    
        <script src="/script.js"></script>
    
    <!-- 文件压缩处理脚本 -->
    <script>
        // 文件大小限制（1MB = 1024 * 1024 bytes）
        const MAX_FILE_SIZE = 1024 * 1024; // 1MB
        const MAX_UPLOAD_SIZE = 5 * 1024 * 1024; // 5MB
        
        // 图片压缩函数
        function compressImage(file, maxSize = MAX_FILE_SIZE) {
            return new Promise((resolve, reject) => {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    reject(new Error('不支持的文件类型'));
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 计算压缩比例
                    let { width, height } = img;
                    let quality = 0.9;
                    
                    // 如果图片太大，先缩小尺寸
                    const maxDimension = 1920;
                    if (width > maxDimension || height > maxDimension) {
                        const ratio = Math.min(maxDimension / width, maxDimension / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 绘制图片
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 压缩函数
                    function compressWithQuality(quality) {
                        return new Promise((resolve) => {
                            canvas.toBlob((blob) => {
                                resolve(blob);
                            }, 'image/jpeg', quality);
                        });
                    }
                    
                    // 递归压缩直到文件大小符合要求
                    async function compressRecursive(quality) {
                        const blob = await compressWithQuality(quality);
                        
                        if (blob.size <= maxSize || quality <= 0.1) {
                            resolve(blob);
                        } else {
                            // 继续压缩，降低质量
                            await compressRecursive(quality - 0.1);
                        }
                    }
                    
                    compressRecursive(quality);
                };
                
                img.onerror = () => reject(new Error('图片加载失败'));
                img.src = URL.createObjectURL(file);
            });
        }
        
        // 处理护照文件上传
        function handlePassportFileUpload(file) {
            const fileInfo = document.getElementById('passportFileInfo');
            const fileInput = document.getElementById('passportUpload');
            
            // 显示原始文件信息
            const originalSize = (file.size / 1024 / 1024).toFixed(2);
            fileInfo.innerHTML = `
                <div style="color: #666; font-size: 14px; margin-top: 8px;">
                    📄 原始文件：${file.name} (${originalSize}MB)
                </div>
            `;
            
            // 检查文件大小
            if (file.size > MAX_UPLOAD_SIZE) {
                fileInfo.innerHTML += `
                    <div style="color: #dc3545; font-size: 14px; margin-top: 4px;">
                        ❌ 文件过大，请选择小于5MB的文件
                    </div>
                `;
                fileInput.value = '';
                return;
            }
            
            // 如果是图片且大于1MB，进行压缩
            if (file.type.startsWith('image/') && file.size > MAX_FILE_SIZE) {
                fileInfo.innerHTML += `
                    <div style="color: #ffc107; font-size: 14px; margin-top: 4px;">
                        ⏳ 正在压缩文件...
                    </div>
                `;
                
                compressImage(file).then(compressedBlob => {
                    const compressedSize = (compressedBlob.size / 1024 / 1024).toFixed(2);
                    
                    // 创建新的File对象
                    const compressedFile = new File([compressedBlob], 
                        file.name.replace(/\.[^/.]+$/, '') + '_compressed.jpg', 
                        { type: 'image/jpeg' }
                    );
                    
                    // 更新文件输入
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(compressedFile);
                    fileInput.files = dataTransfer.files;
                    
                    fileInfo.innerHTML = `
                        <div style="color: #666; font-size: 14px; margin-top: 8px;">
                            📄 原始文件：${file.name} (${originalSize}MB)
                        </div>
                        <div style="color: #28a745; font-size: 14px; margin-top: 4px;">
                            ✅ 压缩完成：${compressedFile.name} (${compressedSize}MB)
                        </div>
                    `;
                }).catch(error => {
                    fileInfo.innerHTML += `
                        <div style="color: #dc3545; font-size: 14px; margin-top: 4px;">
                            ❌ 压缩失败：${error.message}
                        </div>
                    `;
                    fileInput.value = '';
                });
            } else {
                // 文件大小合适，显示成功信息
                fileInfo.innerHTML += `
                    <div style="color: #28a745; font-size: 14px; margin-top: 4px;">
                        ✅ 文件大小合适，无需压缩
                    </div>
                `;
            }
        }
        
        // 页面加载完成后添加事件监听
        document.addEventListener('DOMContentLoaded', function() {
            const passportUpload = document.getElementById('passportUpload');
            
            if (passportUpload) {
                passportUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handlePassportFileUpload(file);
                    }
                });
            }
        });
    </script>
    
 
</body>
</html> 