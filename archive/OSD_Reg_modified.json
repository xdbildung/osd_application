{
  "name": "OSD_Reg",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "submit-registration",
        "options": {
          "noResponseBody": false
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -860,
        40
      ],
      "id": "4f2b98d5-04f4-4860-b6d5-012279dd94bd",
      "name": "Webhook Trigger",
      "webhookId": "6ff74a92-c06a-4505-9f87-29ce59bc13f4"
    },
    {
      "parameters": {
        "jsCode": "// Process payment proof data and attachments\nconst items = $input.all();\n\n// è€ƒè¯•åœºæ¬¡ä»£ç åˆ°ä¸­æ–‡åç§°çš„æ˜ å°„\nconst examSessionMapping = {\n  // åŒ—äº¬è€ƒåœº\n  'A1_BJ_VIP': 'A1å…¨ç§‘ï¼ˆVIPä¸“åœºï¼‰',\n  \n  // æˆéƒ½è€ƒåœº - A1ç­‰çº§\n  'A1_CD_Full': 'A1å…¨ç§‘',\n  'A1_CD_Written': 'A1ç¬”è¯•',\n  'A1_CD_Oral': 'A1å£è¯•',\n  \n  // æˆéƒ½è€ƒåœº - A2ç­‰çº§\n  'A2_CD_Full': 'A2å…¨ç§‘',\n  'A2_CD_Written': 'A2ç¬”è¯•',\n  'A2_CD_Oral': 'A2å£è¯•',\n  \n  // æˆéƒ½è€ƒåœº - B1ç­‰çº§\n  'B1_CD_Full': 'B1å…¨ç§‘',\n  'B1_CD_Listening': 'B1å¬åŠ›',\n  'B1_CD_Oral': 'B1å£è¯­',\n  'B1_CD_Reading': 'B1é˜…è¯»',\n  'B1_CD_Written': 'B1å†™ä½œ'\n};\n\n// è€ƒè¯•åœºæ¬¡ä»£ç åˆ°è€ƒè¯•æ—¥æœŸçš„æ˜ å°„\nconst examDateMapping = {\n  'A1_BJ_VIP': '2025/9/6 (åŒ—äº¬)',\n  'A1_CD_Full': '2025/8/27 (æˆéƒ½)',\n  'A1_CD_Written': '2025/8/27 (æˆéƒ½)',\n  'A1_CD_Oral': '2025/8/27 (æˆéƒ½)',\n  'A2_CD_Full': '2025/8/27 (æˆéƒ½)',\n  'A2_CD_Written': '2025/8/27 (æˆéƒ½)',\n  'A2_CD_Oral': '2025/8/27 (æˆéƒ½)',\n  'B1_CD_Full': '2025/8/27 (æˆéƒ½)',\n  'B1_CD_Listening': '2025/8/27 (æˆéƒ½)',\n  'B1_CD_Oral': '2025/8/27 (æˆéƒ½)',\n  'B1_CD_Reading': '2025/8/27 (æˆéƒ½)',\n  'B1_CD_Written': '2025/8/27 (æˆéƒ½)'\n};\n\n// è€ƒè¯•ç­‰çº§æ˜ å°„\nconst examLevelMapping = {\n  'A1': 'A1ç­‰çº§è€ƒè¯•',\n  'A2': 'A2ç­‰çº§è€ƒè¯•', \n  'B1': 'B1ç­‰çº§è€ƒè¯•'\n};\n\nfor (let item of items) {\n  // Handle test data logging\n  if (item.json.body.test === true) {\n    console.log('ğŸ§ª æ”¶åˆ°æµ‹è¯•æ•°æ®:', {\n      applicationID: item.json.body.applicationID,\n      hasHtml: !!item.json.body.feeDetailsHtml,\n      htmlLength: item.json.body.feeDetailsHtml ? item.json.body.feeDetailsHtml.length : 0,\n      htmlPreview: item.json.body.feeDetailsHtml ? item.json.body.feeDetailsHtml.substring(0, 100) + '...' : 'N/A'\n    });\n    // è·³è¿‡æµ‹è¯•æ•°æ®çš„æ­£å¸¸å¤„ç†æµç¨‹\n    continue;\n  }\n\n  // Handle nationality field\n  if (item.json.body.nationality === 'Other' && item.json.body.otherNationality) {\n    item.json.body.nationality = item.json.body.otherNationality;\n  }\n  \n  // Process exam sessions to determine exam level and exam date\n  if (item.json.body.examSessions) {\n    const sessions = Array.isArray(item.json.body.examSessions) ? \n      item.json.body.examSessions : [item.json.body.examSessions];\n    \n    // Extract exam levels and locations from session codes\n    const levels = new Set();\n    const locations = new Set();\n    const examDetails = [];\n    const examDates = new Set();\n    \n    sessions.forEach(sessionCode => {\n      // è§£æè€ƒè¯•åœºæ¬¡ä»£ç \n      const parts = sessionCode.split('_');\n      if (parts.length >= 3) {\n        const level = parts[0];     // A1, A2, B1\n        const location = parts[1];  // BJ (åŒ—äº¬), CD (æˆéƒ½)\n        const module = parts[2];    // VIP, Full, Written, Oral, Listening, Reading\n        \n        // è½¬æ¢ä½ç½®ä»£ç ä¸ºä¸­æ–‡\n        const locationChinese = location === 'BJ' ? 'åŒ—äº¬' : 'æˆéƒ½';\n        \n        // è·å–ä¸­æ–‡åç§°\n        const sessionName = examSessionMapping[sessionCode] || sessionCode;\n        \n        // è·å–è€ƒè¯•æ—¥æœŸ\n        const examDate = examDateMapping[sessionCode] || 'TBD';\n        \n        levels.add(level);\n        locations.add(locationChinese);\n        examDates.add(examDate);\n        \n        examDetails.push({\n          location: locationChinese,\n          level: level,\n          module: module,\n          sessionCode: sessionCode,\n          sessionName: sessionName,\n          examDate: examDate\n        });\n      }\n    });\n    \n    // Set exam level (æ˜¾ç¤ºæ ¼å¼ï¼šA1ã€A2ç­‰çº§è€ƒè¯•)\n    if (!item.json.body.examLevel || item.json.body.examLevel === '') {\n      const sortedLevels = Array.from(levels).sort();\n      if (sortedLevels.length === 1) {\n        item.json.body.examLevel = examLevelMapping[sortedLevels[0]] || `${sortedLevels[0]}ç­‰çº§è€ƒè¯•`;\n      } else {\n        item.json.body.examLevel = sortedLevels.map(level => examLevelMapping[level] || `${level}ç­‰çº§è€ƒè¯•`).join('ã€');\n      }\n    }\n    \n    // Set exam date based on selected sessions\n    const uniqueDates = Array.from(examDates);\n    if (uniqueDates.length === 1) {\n      item.json.body.examDate = uniqueDates[0];\n    } else if (uniqueDates.length > 1) {\n      // å¦‚æœæœ‰å¤šä¸ªæ—¥æœŸï¼ŒæŒ‰æ—¥æœŸæ’åº\n      item.json.body.examDate = uniqueDates.sort().join('ï¼› ');\n    } else {\n      item.json.body.examDate = 'TBD';\n    }\n    \n    // Set exam sessions display (ä¸­æ–‡åç§°)\n    const sessionNames = sessions.map(code => examSessionMapping[code] || code);\n    item.json.body.examSessionsDisplay = sessionNames.join('ã€');\n    \n    item.json.body.examDetails = examDetails;\n  } else {\n    item.json.body.examDate = 'TBD';\n    item.json.body.examSessionsDisplay = 'æ— ';\n    item.json.body.examLevel = 'N/A';\n  }\n  \n  // Handle fee details HTML for email\n  if (!item.json.body.feeDetailsHtml) {\n    // If front-end didn't provide feeDetailsHtml, generate a simple one\n    if (item.json.body.feeDetails && Array.isArray(item.json.body.feeDetails)) {\n      const feeDetailsHtml = item.json.body.feeDetails.map(detail => \n        `<div style=\"display: flex; justify-content: space-between; margin: 5px 0;\">\n          <span>${detail.description}</span>\n          <span><strong>Â¥${detail.fee}</strong></span>\n        </div>`\n      ).join('');\n      item.json.body.feeDetailsHtml = feeDetailsHtml;\n    } else {\n      item.json.body.feeDetailsHtml = '<div style=\"text-align: center; color: #666;\">æš‚æ— è´¹ç”¨ä¿¡æ¯</div>';\n    }\n  }\n  // If front-end provided feeDetailsHtml, use it directly\n  \n  // Process payment proof attachment\n  if (item.json.body.paymentProof && item.json.body.paymentProof.content) {\n    const paymentData = item.json.body.paymentProof;\n    \n    // Convert base64 to binary buffer\n    const binaryBuffer = Buffer.from(paymentData.content, 'base64');\n    \n    // Create binary data property for payment proof\n    item.binary = item.binary || {};\n    item.binary.paymentProof = {\n      data: binaryBuffer,\n      mimeType: paymentData.mimeType || 'application/octet-stream',\n      fileName: paymentData.filename || 'payment_proof'\n    };\n    \n    // Mark payment as uploaded\n    item.json.body.paymentUploaded = true;\n  } else {\n    item.json.body.paymentUploaded = false;\n  }\n  \n  // Process signed document if still present\n  if (item.json.body.signedDocument && item.json.body.signedDocument.content) {\n    const attachmentData = item.json.body.signedDocument;\n    const binaryBuffer = Buffer.from(attachmentData.content, 'base64');\n    \n    item.binary = item.binary || {};\n    item.binary.signedDocument = {\n      data: binaryBuffer,\n      mimeType: attachmentData.mimeType || 'application/octet-stream',\n      fileName: attachmentData.filename || 'signed_document'\n    };\n  }\n  \n  // Process passport upload if present\n  if (item.json.body.passportUpload && item.json.body.passportUpload.content) {\n    const passportData = item.json.body.passportUpload;\n    const binaryBuffer = Buffer.from(passportData.content, 'base64');\n    \n    item.binary = item.binary || {};\n    item.binary.passport = {\n      data: binaryBuffer,\n      mimeType: passportData.mimeType || 'application/octet-stream',\n      fileName: passportData.filename || 'passport'\n    };\n  }\n  \n  // Add payment submission timestamp\n  if (!item.json.body.paymentSubmissionTime) {\n    item.json.body.paymentSubmissionTime = new Date().toISOString();\n  }\n  \n  // Format timestamps for display\n  item.json.body.paymentSubmissionTimeFormatted = new Date(item.json.body.paymentSubmissionTime).toLocaleString('zh-CN');\n  item.json.body.originalSubmissionTimeFormatted = new Date(item.json.body.timestamp).toLocaleString('zh-CN');\n}\n\nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        40
      ],
      "id": "a2d0c0b8-5b89-4a3d-8b18-41d299f18f36",
      "name": "Process Form Data"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1GBu2AgIhKBJE5q34Hk6s6DL6fRaTW-yqiZMf8blVNd0",
          "mode": "list",
          "cachedResultName": "test_registration_sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1GBu2AgIhKBJE5q34Hk6s6DL6fRaTW-yqiZMf8blVNd0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1e7IBYNKiEvdZOscI0YaBK9uk6ReymltU0bWHJZ1e3D8/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "FirstName": "={{ $json.body.firstName }}",
            "LastName": "={{ $json.body.lastName }}",
            "Gender": "={{ $json.body.gender }}",
            "BirthDate": "={{ $json.body.birthDate }}",
            "Nationality": "={{ $json.body.nationality }}",
            "BirthPlace": "={{ $json.body.birthPlace }}",
            "Passport": "={{ $json.body.passportNumber }}",
            "E-mail": "={{ $json.body.email }}",
            "Mobile": "={{ $json.body.phoneNumber }}",
            "First_Time": "={{ $json.body.firstTimeExam }}",
            "A2_CD_Written": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('A2_CD_Written') || $json.body.examSessions.join(',').includes('A2_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "A2_CD_Oral": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('A2_CD_Oral') || $json.body.examSessions.join(',').includes('A2_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "A1_CD_Written": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('A1_CD_Written') || $json.body.examSessions.join(',').includes('A1_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "A1_CD_Oral": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('A1_CD_Oral') || $json.body.examSessions.join(',').includes('A1_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "TestDate": "={{ $json.body.examDate }}",
            "PassportUploaded": "={{ $json.body.passportUpload ? 'TRUE' : 'FALSE' }}",
            "Reg_Time": "={{ $json.body.timestamp }}",
            "applicationID": "={{ $json.body.applicationID }}",
            "A1_BJ_VIP": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('A1_BJ_VIP') || $json.body.examSessions.join(',').includes('A1_BJ_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "B1_CD_Listening": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('B1_CD_Listening') || $json.body.examSessions.join(',').includes('B1_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "B1_CD_Oral": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('B1_CD_Oral') || $json.body.examSessions.join(',').includes('B1_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "B1_CD_Reading": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('B1_CD_Reading') || $json.body.examSessions.join(',').includes('B1_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "B1_CD_Written": "={{ $json.body.examSessions ? ($json.body.examSessions.join(',').includes('B1_CD_Written') || $json.body.examSessions.join(',').includes('B1_CD_Full') ? 'TRUE' : 'FALSE') : 'FALSE' }}",
            "FullName": "={{ $json.body.lastName + ' ' + $json.body.firstName }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "FullName",
              "displayName": "FullName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "FirstName",
              "displayName": "FirstName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastName",
              "displayName": "LastName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Gender",
              "displayName": "Gender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "BirthDate",
              "displayName": "BirthDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Nationality",
              "displayName": "Nationality",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "BirthPlace",
              "displayName": "BirthPlace",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Passport",
              "displayName": "Passport",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "E-mail",
              "displayName": "E-mail",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Mobile",
              "displayName": "Mobile",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "First_Time",
              "displayName": "First_Time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "A1_BJ_VIP",
              "displayName": "A1_BJ_VIP",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "A1_CD_Written",
              "displayName": "A1_CD_Written",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "A1_CD_Oral",
              "displayName": "A1_CD_Oral",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "A2_CD_Written",
              "displayName": "A2_CD_Written",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "A2_CD_Oral",
              "displayName": "A2_CD_Oral",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "B1_CD_Listening",
              "displayName": "B1_CD_Listening",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "B1_CD_Oral",
              "displayName": "B1_CD_Oral",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "B1_CD_Reading",
              "displayName": "B1_CD_Reading",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "B1_CD_Written",
              "displayName": "B1_CD_Written",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "TestDate",
              "displayName": "TestDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PassportUploaded",
              "displayName": "PassportUploaded",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Reg_Time",
              "displayName": "Reg_Time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "applicationID",
              "displayName": "applicationID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -420,
        260
      ],
      "id": "e46009a8-c62b-4929-b03b-01d669225d19",
      "name": "Google Sheets",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OWrqKQaJ59Y0WeAD",
          "name": "Skee's Google Sheet"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": true, \"message\": \"æŠ¥åæˆåŠŸï¼è¯·æŸ¥æ”¶é‚®ä»¶ï¼\"}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        460,
        40
      ],
      "id": "82cffa34-4422-4f6d-8db3-3d58c07e79ab",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "fromEmail": "info@sdi-osd.de",
        "toEmail": "={{ $json.body.email }}",
        "subject": "=ğŸ‰ {{ $json.body.lastName }} {{ $json.body.firstName }} - SDIå¥¥å¾·è€ƒè¯•æŠ¥åæˆåŠŸç¡®è®¤å‡½",
        "html": "=<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>é‡è¦é€šçŸ¥ï¼šSDIå¥¥å¾·è€ƒè¯•æŠ¥åç¡®è®¤æ­¥éª¤</title>\n</head>\n<body>\n    <div style=\"font-family: Arial, 'Microsoft YaHei', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #ffffff;\">\n\n        <div style=\"text-align: center; margin-bottom: 30px;\">\n            <h1 style=\"color: #F0B83F; font-size: 24px; margin: 0;\">ğŸ‰ æŠ¥åæˆåŠŸ & å¸­ä½æœ€ç»ˆç¡®è®¤å‡½</h1>\n            <hr style=\"border: none; height: 2px; background: linear-gradient(to right, #F0B83F, #FFE0B2); margin: 20px 0;\">\n        </div>\n\n        <div style=\"margin-bottom: 20px; line-height: 1.6;\">\n            <strong>äº²çˆ±çš„ {{ $json.body.lastName }} {{ $json.body.firstName }} åŒå­¦ï¼š</strong>\n            <p style=\"margin-top: 10px;\">ç¥è´ºä½ ï¼ ä½ å·²é¡ºåˆ©å®Œæˆæ…•å°¼é»‘SDIè¯­è¨€å¤§å­¦å¥¥å¾·è€ƒè¯•ä¸­å¿ƒçš„è€ƒè¯•æŠ¥åï¼</p>\n            <p>ä»¥ä¸‹æ˜¯æ‚¨çš„æŠ¥åä¿¡æ¯ï¼Œè¯·æ ¸å¯¹ï¼š</p>\n        </div>\n\n        <div style=\"background: #FFF8E1; padding: 20px; border-radius: 8px; border-left: 4px solid #F0B83F; margin: 20px 0;\">\n            <h3 style=\"color: #F0B83F; margin-top: 0;\">ğŸ“‹ æ‚¨çš„æŠ¥åä¿¡æ¯</h3>\n            <p><strong>ç”³è¯·ç¼–å·ï¼š</strong>{{ $json.body.applicationID }}</p>\n            <p><strong>æŠ¥åç­‰çº§ï¼š</strong>{{ $json.body.examLevel }}</p>\n            <p><strong>æŠ¥åç§‘ç›®ï¼š</strong>{{ $json.body.examSessionsDisplay }}</p>\n            <p><strong>è€ƒè¯•æ—¥æœŸï¼š</strong>{{ $json.body.examDate }}</p>\n            <p><strong>æŠ¤ç…§å·ç ï¼š</strong>{{ $json.body.passportNumber }}</p>\n            <p><strong>æŠ¥åæ—¶é—´ï¼š</strong>{{ $json.body.originalSubmissionTimeFormatted }}</p>\n        </div>\n\n        <div style=\"background: #FFF3E0; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n            <h3 style=\"color: #E65100; margin-top: 0;\">ğŸ’° æŠ¥åè´¹ç”¨ä¿¡æ¯</h3>\n            <div style=\"background: white; padding: 15px; border-radius: 5px; margin: 10px 0;\">\n  \n<!-- è´¹ç”¨æ˜ç»†æ¨¡å— -->\n                {{ $json.body.feeDetailsHtml }}\n                <hr style=\"margin: 10px 0;\">\n                <div style=\"display: flex; justify-content: space-between; font-weight: bold; font-size: 16px;\">\n                    <span>åº”ä»˜æ€»é¢ï¼š</span>\n                    <span style=\"color: #E65100;\">Â¥{{ $json.body.totalFee }}</span>\n                </div>\n            </div>\n<!-- ğŸ†• æ–°å¢ï¼šé“¶è¡Œè½¬è´¦ä¿¡æ¯éƒ¨åˆ† -->\n<div style=\"background: #E8F5E8; padding: 20px; border-radius: 8px; border-left: 4px solid #4CAF50; margin: 20px 0;\">\n    <h3 style=\"color: #2E7D32; margin-top: 0;\">ğŸ¦ è€ƒè¯•è´¹ä»˜è´¹ä¿¡æ¯</h3>\n    <div style=\"background: white; padding: 15px; border-radius: 5px; margin: 10px 0;\">\n        {{ $json.body.bankTransferHtml }}\n    </div>\n    \n    <!-- å¾®ä¿¡æ‰«ç æ”¯ä»˜ä¿¡æ¯ -->\n    <h3 style=\"color: #2E7D32; margin-top: 20px; margin-bottom: 10px;\">ğŸ“± å¾®ä¿¡æ‰«ç æ”¯ä»˜ä¿¡æ¯</h3>\n    <div style=\"text-align: center; margin: 15px 0;\">\n        {{ $json.qrCodeDataUri ? '<img src=\"' + $json.qrCodeDataUri + '\" alt=\"å¾®ä¿¡æ”¯ä»˜äºŒç»´ç \" style=\"max-width: 200px; height: auto; border: 1px solid #ddd; border-radius: 8px;\">' : '<p style=\"color: #666;\">äºŒç»´ç åŠ è½½ä¸­...</p>' }}\n    </div>\n    \n    <p style=\"margin-top: 15px;\"><strong>âš ï¸ é‡è¦æé†’ï¼š</strong>è¯·åœ¨å®Œæˆã€Šè€ƒè¯•é¡»çŸ¥ã€‹ç­¾å­—ç¡®è®¤åï¼ŒåŠæ—¶å®Œæˆè´¹ç”¨æ”¯ä»˜ä»¥ç¡®ä¿è€ƒè¯•å¸­ä½ã€‚</p>\n</div>\n        <div style=\"background: #E3F2FD; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n            <h3 style=\"color: #1976D2; margin-top: 0;\">ğŸ”‘ ä¸‹ä¸€æ­¥ï¼šæœ€ç»ˆç¡®è®¤æ‚¨çš„è€ƒè¯•å¸­ä½</h3>\n            <p>ä¸ºç¡®ä¿æ‚¨çš„è€ƒè¯•å¸­ä½æœ€ç»ˆè¢«ç¡®è®¤ï¼Œè¯·åŠ¡å¿…å®Œæˆä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š</p>\n            <ol style=\"line-height: 1.8; padding-left: 25px;\">\n                <li><strong>ä¸‹è½½é™„ä»¶ï¼š</strong> è¯·æŸ¥æ”¶å¹¶ä¸‹è½½æœ¬é‚®ä»¶é™„ä»¶ä¸­çš„ã€Šè€ƒè¯•é¡»çŸ¥ã€‹ã€‚</li>\n                <li><strong>ä»”ç»†é˜…è¯»å¹¶ç­¾å­—ï¼š</strong> è¯·è®¤çœŸé˜…è¯»æ–‡ä»¶å†…å®¹ï¼Œå¹¶åœ¨æŒ‡å®šä½ç½®äº²ç¬”ç­¾åã€‚</li>\n                <li><strong>å›ä¼ ç­¾å­—æ–‡ä»¶ï¼š</strong> è¯·é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹å¼å›ä¼ ï¼š\n                    <ul style=\"list-style-type: disc; margin-left: 20px; padding-left: 20px;\">\n                        <li><strong>æ–¹å¼ä¸€ (æ¨è)ï¼š</strong>å°†å·²ç­¾å­—çš„ã€Šè€ƒè¯•é¡»çŸ¥ã€‹ç›´æ¥ä½œä¸ºé™„ä»¶å›å¤æ­¤é‚®ä»¶ã€‚</li>\n                        <li><strong>æ–¹å¼äºŒï¼š</strong>å°†å·²ç­¾å­—çš„ã€Šè€ƒè¯•é¡»çŸ¥ã€‹æäº¤ç»™æ‚¨çš„ç•™å­¦å’¨è¯¢è€å¸ˆï¼Œç”±å…¶è½¬äº¤ç»™æˆ‘ä»¬ã€‚</li>\n                    </ul>\n                </li>\n                <li><strong>è¡¥å……æŠ¤ç…§ä¿¡æ¯ (å¦‚éœ€)ï¼š</strong>è‹¥æ‚¨åœ¨æŠ¥åæ—¶æœªæäº¤æŠ¤ç…§ä¿¡æ¯ï¼Œè¯·åŠ¡å¿…åœ¨<strong><u>è€ƒè¯•æ—¥æœŸå‰è‡³å°‘14å¤©</u></strong>å›å¤æœ¬é‚®ä»¶è¡¥å……æäº¤ã€‚</li>\n            </ol>\n        </div>\n\n        <div style=\"background: #FFF3E0; padding: 20px; border-radius: 8px; border-left: 4px solid #E65100; margin: 20px 0;\">\n            <h3 style=\"color: #E65100; margin-top: 0;\">âš ï¸ é‡è¦æˆªæ­¢æ—¥æœŸæé†’</h3>\n            <p>è¯·åŠ¡å¿…åœ¨ <strong>2025å¹´8æœˆ5æ—¥ 24:00 (åŒ—äº¬æ—¶é—´)</strong> å‰å°†ç­¾å­—æ–‡ä»¶å‘é€ç»™æˆ‘ä»¬ã€‚</p>\n            <p><strong>è‹¥æˆ‘ä»¬æœªèƒ½åœ¨æˆªæ­¢æ—¥æœŸå‰æ”¶åˆ°æ‚¨çš„ç­¾å­—æ–‡ä»¶ï¼Œå°†æ— æ³•ä¿è¯ä¸ºæ‚¨é¢„ç•™è€ƒè¯•ä½ç½®ã€‚</strong></p>\n        </div>\n        \n        <div style=\"background: #F5F5F5; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n            <h3 style=\"color: #333; margin-top: 0;\">ğŸ“… åç»­æ­¥éª¤åŠè€ƒè¯•æ—¥æé†’</h3>\n            <ul style=\"line-height: 1.8; padding-left: 25px;\">\n                <li><strong>æ­£å¼è€ƒè¯•ç¡®è®¤å‡½ï¼š</strong>å®Œæˆä¸Šè¿°ç­¾å­—æ­¥éª¤åï¼Œæ‚¨å°†åœ¨è€ƒå‰5-7å¤©æ”¶åˆ°æ­£å¼çš„ã€Šè€ƒè¯•ç¡®è®¤å‡½ã€‹ï¼Œå…¶ä¸­å°†åŒ…å«å…·ä½“çš„è€ƒåœºåœ°å€å’Œè¯¦ç»†æ³¨æ„äº‹é¡¹ã€‚</li>\n                <li><strong>æ‰“å°æ–‡ä»¶ï¼š</strong>æ”¶åˆ°æ­£å¼ã€Šè€ƒè¯•ç¡®è®¤å‡½ã€‹åï¼Œè¯·åŠ¡å¿…å°†å…¶æ‰“å°ä¸ºçº¸è´¨ç‰ˆã€‚</li>\n                <li><strong>æºå¸¦è¯ä»¶ï¼š</strong>è€ƒè¯•å½“å¤©å¿…é¡»æºå¸¦<strong>æŠ¤ç…§åŸä»¶</strong>åŠ<strong>çº¸è´¨ç‰ˆã€Šè€ƒè¯•ç¡®è®¤å‡½ã€‹</strong>ã€‚</li>\n                <li><strong>åˆ°è¾¾æ—¶é—´ï¼š</strong>è¯·æå‰30åˆ†é’Ÿåˆ°è¾¾è€ƒåœºã€‚</li>\n            </ul>\n        </div>\n\n        <div style=\"margin: 30px 0; line-height: 1.6;\">\n            <p>è¯·æŠ“ç´§æ—¶é—´å®Œæˆå¸­ä½ç¡®è®¤çš„å…³é”®æ­¥éª¤ï¼Œç¥æ‚¨å¤‡è€ƒé¡ºåˆ©ï¼</p>\n            <p>å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·éšæ—¶é€šè¿‡é‚®ä»¶è”ç³»æˆ‘ä»¬ï¼š<a href=\"mailto:info@sdi-osd.de\" style=\"color: #F0B83F; text-decoration: none;\">info@sdi-osd.de</a></p>\n        </div>\n\n        <hr style=\"border: none; height: 1px; background: #ddd; margin: 30px 0;\">\n\n        <div style=\"font-size: 14px; color: #666; text-align: center; line-height: 1.6;\">\n            <p><strong>SDI Internationale Hochschule MÃ¼nchen</strong><br>Kontakt: info@sdi-osd.de</p>\n            <p><strong>æ…•å°¼é»‘SDIè¯­è¨€å¤§å­¦</strong><br>å¥¥å¾·è€ƒè¯•ä¸­å¿ƒ</p>\n        </div>\n\n    </div>\n</body>\n</html>",
        "attachments": "notification",
        "options": {}
      },
      "name": "Send Success Email to Student",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [
        20,
        -60
      ],
      "id": "5a97702b-aeff-4b10-b526-de752ba0515b",
      "credentials": {
        "smtp": {
          "id": "evEHcleKBaWVF93k",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1oIMEWuzNuj_8zwEY1-I9oDYPDMeVrP5y",
          "mode": "list",
          "cachedResultName": "SDI_exam_notification.pdf",
          "cachedResultUrl": "https://drive.google.com/file/d/1oIMEWuzNuj_8zwEY1-I9oDYPDMeVrP5y/view?usp=drivesdk"
        },
        "options": {
          "binaryPropertyName": "notification"
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -420,
        40
      ],
      "id": "49986409-0a88-4097-88df-00a92a2b2d6b",
      "name": "Google Drive",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "zsMGAxLZF0nMTMQI",
          "name": "Skee's google drive"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "info@sdi-osd.de",
        "toEmail": "skee.chen@xuezaideguo.com",
        "subject": "=å­¦ç”Ÿå·²å®ŒæˆæŠ¥å - {{ $json.body.lastName }} {{ $json.body.firstName }}",
        "html": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\"><h2 style=\"color: #4CAF50;\">âœ… å­¦ç”Ÿå·²å®ŒæˆæŠ¥å</h2><div style=\"background: #E8F5E8; padding: 15px; border-radius: 8px; margin: 20px 0;\"><h3>ğŸ‘¤ å­¦ç”Ÿä¿¡æ¯</h3><p>â€¢ <strong>ç”³è¯·ç¼–å·ï¼š</strong>{{ $json.body.applicationID }} </p><p>â€¢ <strong>å§“åï¼š</strong>{{ $json.body.lastName }} {{ $json.body.firstName }}</p><p>â€¢ <strong>æ€§åˆ«ï¼š</strong>{{ $json.body.gender }}</p><p>â€¢ <strong>å‡ºç”Ÿæ—¥æœŸï¼š</strong>{{ $json.body.birthDate }}</p><p>â€¢ <strong>å›½ç±ï¼š</strong>{{ $json.body.nationality }}</p><p>â€¢ <strong>å‡ºç”Ÿåœ°ï¼š</strong>{{ $json.body.birthPlace }}</p><p>â€¢ <strong>é‚®ç®±ï¼š</strong>{{ $json.body.email }}</p><p>â€¢ <strong>æ‰‹æœºå·ç ï¼š</strong>{{ $json.body.phoneNumber }}</p><p>â€¢ <strong>æŠ¤ç…§å·ç ï¼š</strong>{{ $json.body.passportNumber }}</p></div><div style=\"background: #FFF3E0; padding: 15px; border-radius: 8px; margin: 20px 0;\"><h3>ğŸ“š è€ƒè¯•ä¿¡æ¯</h3><p>â€¢ <strong>è€ƒè¯•åœºæ¬¡ï¼š</strong>{{ $json.body.examSessionsDisplay }}</p><p>â€¢ <strong>è€ƒè¯•æ—¥æœŸï¼š</strong>{{ $json.body.examDate }}</p><p>â€¢ <strong>è€ƒè¯•ç­‰çº§ï¼š</strong>{{ $json.body.examLevel }}</p><p><strong>æŠ¥åç§‘ç›®ï¼š</strong>{{ $json.body.examSessionsDisplay }}</p>\n<p><strong>åº”ä»˜è´¹ç”¨ï¼š</strong>Â¥{{ $json.body.totalFee }}</p></div><div style=\"background: #E3F2FD; padding: 15px; border-radius: 8px; margin: 20px 0;\"><h3>â° æ—¶é—´ä¿¡æ¯</h3><p>â€¢ <strong>æŠ¥åæ—¶é—´ï¼š</strong>{{ $json.body.originalSubmissionTimeFormatted }}</p></div><div style=\"background: #FFEBEE; padding: 15px; border-radius: 8px; margin: 20px 0;\"><h3>ğŸ“ é™„ä»¶ä¿¡æ¯</h3><p>â€¢ <strong>æŠ¤ç…§ä¿¡æ¯ï¼š</strong>{{ $json.body.passportUpload ? $json.body.passportUpload.filename : 'æœªä¸Šä¼ ' }}</p></div><p style=\"margin-top: 30px; font-size: 14px; color: #666;\">è¯·åŠæ—¶å¤„ç†å­¦ç”Ÿçš„ä»˜è´¹ç¡®è®¤ï¼Œå¿…è¦æ—¶å¯è”ç³»å­¦ç”Ÿè¿›è¡Œç¡®è®¤ã€‚</p></div>",
        "attachments": "={{ $binary.paymentProof ? ($binary.passport ? ($binary.signedDocument ? 'paymentProof,passport,signedDocument' : 'paymentProof,passport') : ($binary.signedDocument ? 'paymentProof,signedDocument' : 'paymentProof')) : ($binary.passport ? ($binary.signedDocument ? 'passport,signedDocument' : 'passport') : ($binary.signedDocument ? 'signedDocument' : '')) }}",
        "options": {}
      },
      "name": "Send Application Notification to Admin",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [
        240,
        -60
      ],
      "id": "3bae8b93-0a85-498d-b7c5-49f51887aa59",
      "credentials": {
        "smtp": {
          "id": "evEHcleKBaWVF93k",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1xfuULRtJDt8KwB7gpClqI_jIDFoTTWuW",
          "mode": "list",
          "cachedResultName": "payment_QR_example.png",
          "cachedResultUrl": "https://drive.google.com/file/d/1xfuULRtJDt8KwB7gpClqI_jIDFoTTWuW/view?usp=drivesdk"
        },
        "options": {
          "binaryPropertyName": "payment_QR"
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -420,
        -160
      ],
      "id": "af37e84e-f8ee-4c26-8e96-ef21a6b89506",
      "name": "Google Drive1",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "zsMGAxLZF0nMTMQI",
          "name": "Skee's google drive"
        }
      }
    },
          {
        "parameters": {
          "mode": "combine",
          "combineBy": "combineByIndex",
          "options": {}
        },
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          -200,
          -60
        ],
        "id": "e907b0c4-06f5-41cd-80a9-381fca367844",
        "name": "Merge Binary Data"
      },
      {
        "parameters": {
          "jsCode": "// Convert QR code binary to base64 for email embedding\nconst items = $input.all();\n\nfor (let item of items) {\n  console.log('Processing item:', {\n    hasBinary: !!item.binary,\n    binaryKeys: item.binary ? Object.keys(item.binary) : [],\n    hasNotification: !!(item.binary && item.binary.notification),\n    hasPaymentQR: !!(item.binary && item.binary.payment_QR)\n  });\n  \n  // Check if we have the payment_QR binary data\n  if (item.binary && item.binary.payment_QR) {\n    const qrBinary = item.binary.payment_QR;\n    const base64Data = qrBinary.data.toString('base64');\n    const mimeType = qrBinary.mimeType || 'image/png';\n    \n    // Create data URI for embedding in email\n    item.json.qrCodeDataUri = `data:${mimeType};base64,${base64Data}`;\n    \n    console.log('âœ… QR code converted to base64, length:', base64Data.length);\n  } else {\n    console.log('âŒ No payment_QR binary data found');\n    item.json.qrCodeDataUri = '';\n  }\n  \n  // Ensure notification binary is preserved\n  if (!item.binary || !item.binary.notification) {\n    console.log('âš ï¸ Warning: notification binary data missing');\n  } else {\n    console.log('âœ… Notification binary data present');\n  }\n}\n\nreturn items;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -40,
          -60
        ],
        "id": "convert-qr-to-base64",
        "name": "Convert QR to Base64"
      }
  ],
  "pinData": {},
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Process Form Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Form Data": {
      "main": [
        [
          {
            "node": "Google Sheets",
            "type": "main",
            "index": 0
          },
          {
            "node": "Google Drive",
            "type": "main",
            "index": 0
          },
          {
            "node": "Google Drive1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Drive": {
      "main": [
        [
          {
            "node": "Merge Binary Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Send Success Email to Student": {
      "main": [
        [
          {
            "node": "Send Application Notification to Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Application Notification to Admin": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Drive1": {
      "main": [
        [
          {
            "node": "Merge Binary Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Binary Data": {
      "main": [
        [
          {
            "node": "Convert QR to Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert QR to Base64": {
      "main": [
        [
          {
            "node": "Send Success Email to Student",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "53e7442f-10cd-4ea6-b192-084e35511cbf",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "62c4f474723b914af91e4af15e30298257d6540140abed5d09006251f9987da1"
  },
  "id": "ThG9oxXxEHkbCV5I",
  "tags": []
}