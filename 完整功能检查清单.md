# ✅ 完整功能检查清单

## 📋 本次开发完成的所有功能

### 1. 数据库连接功能
### 2. 专属代码（Coupon）功能
### 3. 价格调整功能
### 4. 地点映射动态化功能

---

## 🔍 详细检查步骤

### 准备工作：启动本地服务器

**在项目根目录运行：**
```bash
python -m http.server 8000
```

**然后在浏览器打开：**
```
http://localhost:8000/index.html
```

**按 F12 打开开发者工具**

---

## ✅ 检查项 1：数据库连接功能

### 1.1 检查 Supabase 配置

在控制台执行：
```javascript
// 检查配置是否存在
console.log('Supabase URL:', SUPABASE_URL);
console.log('Supabase Key:', SUPABASE_ANON_KEY ? '✓ 已配置' : '✗ 未配置');
```

**✅ 预期结果：**
```
Supabase URL: https://totxnqrbgvppdrziynpz.supabase.co
Supabase Key: ✓ 已配置
```

---

### 1.2 检查考试场次数据加载

**在页面加载时，控制台应该自动显示：**
```
🔄 正在从 Supabase 加载考试场次数据...
✅ 成功加载场次数据: X 个场次
🔄 正在从 Supabase 加载产品价格数据...
✅ 成功加载产品数据: X 个产品
```

**手动检查数据：**
```javascript
// 查看加载的场次数据
console.log('场次数据:', examSessionsData);
console.log('场次数量:', examSessionsData.length);

// 查看数据结构
if (examSessionsData.length > 0) {
    console.log('第一个场次示例:', examSessionsData[0]);
}
```

**✅ 预期结果：**
- `examSessionsData` 是一个数组
- 每个场次包含：`id`, `date`, `location`, `levels`, `is_active`
- 只包含 `is_active = true` 的场次

---

### 1.3 检查产品价格数据加载

```javascript
// 查看产品数据
console.log('产品数据:', examProductsData);
console.log('产品数量:', examProductsData.length);

// 查看产品结构
if (examProductsData.length > 0) {
    console.log('第一个产品示例:', examProductsData[0]);
}

// 检查价格字段
const sampleProduct = examProductsData[0];
console.log('产品代码:', sampleProduct?.code);
console.log('原价（分）:', sampleProduct?.price_original);
console.log('折后价（分）:', sampleProduct?.price_discounted);
```

**✅ 预期结果：**
- `examProductsData` 是一个数组
- 每个产品包含：`id`, `code`, `name`, `level`, `location`, `module_type`, `price_original`, `price_discounted`
- 价格单位为"分"（如 160000 = 1600元）

---

### 1.4 检查动态渲染功能

**查看页面上的场次选择区域：**

1. 页面上应该显示从数据库加载的场次
2. 每个场次显示：
   - 城市名称（中文）
   - 考试日期
   - 如果 `is_active = false`，显示"报名已截止"并禁用

**测试动态渲染：**
```javascript
// 检查渲染函数是否存在
console.log('渲染场次函数:', typeof renderExamSessions);
console.log('渲染产品函数:', typeof renderExamProducts);
```

**✅ 预期结果：**
```
渲染场次函数: function
渲染产品函数: function
```

---

## ✅ 检查项 2：专属代码功能

### 2.1 检查 UI 元素

**在页面上查找：**
- [ ] 有"专属代码（可选）"标签
- [ ] 有输入框（placeholder: "请输入专属代码"）
- [ ] 有"验证专属代码"按钮
- [ ] 有状态显示区域（`#couponStatus`）

**在控制台检查：**
```javascript
// 检查 DOM 元素
console.log('专属代码输入框:', document.getElementById('couponCode'));
console.log('验证按钮:', document.getElementById('validateCouponBtn'));
console.log('状态区域:', document.getElementById('couponStatus'));
```

**✅ 预期结果：** 所有元素都存在（不为 null）

---

### 2.2 检查验证函数

```javascript
// 检查验证函数是否存在
console.log('验证函数:', typeof validateCouponCode);

// 查看全局变量
console.log('已验证的专属代码:', validatedCoupon);
console.log('选中的场次ID:', selectedSessionId);
```

**✅ 预期结果：**
```
验证函数: function
已验证的专属代码: null (初始状态)
选中的场次ID: null (初始状态)
```

---

### 2.3 功能测试：验证专属代码

**步骤：**
1. 选择一个考试场次
2. 在专属代码输入框中输入测试代码
3. 点击"验证专属代码"按钮

**测试场景 A：未选择场次**
```
操作：直接输入代码并验证
预期：显示红色提示"请先选择考试场次"
```

**测试场景 B：空代码**
```
操作：不输入代码直接点验证
预期：显示红色提示"请输入专属代码"
```

**测试场景 C：错误的代码**
```
操作：输入 "INVALID123"
预期：显示红色提示"专属代码无效或不适用于此场次"
控制台：🔄 正在验证专属代码: INVALID123 场次ID: [UUID]
```

**测试场景 D：正确的代码（需要数据库有对应数据）**
```
操作：输入正确的专属代码
预期：
  - 显示绿色提示"✅ 专属代码验证成功！"
  - 控制台：✅ 专属代码验证成功: {code, session_id, ...}
  - validatedCoupon 变量有值
```

**控制台验证：**
```javascript
// 验证后检查
console.log('验证状态:', validatedCoupon);
```

---

### 2.4 检查专属代码与价格联动

**在控制台测试：**
```javascript
// 模拟选择全科考试
const fullCourseProduct = examProductsData.find(p => p.module_type === 'Full');
console.log('全科产品:', fullCourseProduct);
console.log('原价（元）:', fullCourseProduct.price_original / 100);
console.log('折后价（元）:', fullCourseProduct.price_discounted / 100);

// 检查费用计算函数
console.log('费用计算函数:', typeof calculateTotalFee);
```

**✅ 预期结果：**
- 全科产品有 `price_discounted` 值
- 例如：A1全科原价 1600 元，折后价 1400 元

---

## ✅ 检查项 3：价格调整功能

### 3.1 检查价格数据结构

```javascript
// 查看所有产品的价格
examProductsData.forEach(product => {
    console.log(`${product.name}:`, {
        原价: product.price_original / 100 + '元',
        折后价: product.price_discounted ? product.price_discounted / 100 + '元' : '无折扣',
        模块类型: product.module_type
    });
});
```

**✅ 预期结果：**
```
A1全科: {原价: "1600元", 折后价: "1400元", 模块类型: "Full"}
A1笔试: {原价: "950元", 折后价: "无折扣", 模块类型: "Written"}
A1口试: {原价: "600元", 折后价: "无折扣", 模块类型: "Oral"}
A2全科: {原价: "1700元", 折后价: "1500元", 模块类型: "Full"}
A2笔试: {原价: "1000元", 折后价: "无折扣", 模块类型: "Written"}
...
```

**关键点：**
- ✅ 全科考试（Full）有折后价
- ✅ 单科考试（Written/Oral/Listening/Reading）无折扣（NULL）
- ✅ 折扣金额为 200 元（20000 分）

---

### 3.2 测试费用计算（无专属代码）

**步骤：**
1. 选择一个考试场次
2. 选择考试科目（如 A1全科）
3. **不输入专属代码**
4. 在控制台查看计算结果

```javascript
// 获取当前选择的科目
const checkedSessions = Array.from(document.querySelectorAll('input[name="examSessions"]:checked'))
    .map(cb => cb.value);
console.log('已选科目:', checkedSessions);

// 计算费用
const feeResult = calculateTotalFee(checkedSessions);
console.log('费用计算结果:', feeResult);
```

**✅ 预期结果（选择 A1全科，无专属代码）：**
```javascript
{
    totalFee: 1600,
    details: [
        {
            session: "A1_CD_Full",
            fee: 1600,
            description: "A1全科",
            originalFee: 1600,
            discountedFee: 1400,
            isDiscounted: false  // ← 因为没有专属代码
        }
    ]
}
```

---

### 3.3 测试费用计算（有专属代码 + 全科）

**步骤：**
1. 选择考试场次
2. 输入并验证专属代码（确保验证成功）
3. 选择全科考试
4. 查看费用

```javascript
// 计算费用
const feeResult = calculateTotalFee(checkedSessions);
console.log('费用计算结果（有专属代码）:', feeResult);
```

**✅ 预期结果（选择 A1全科，有专属代码）：**
```javascript
{
    totalFee: 1400,  // ← 使用折后价
    details: [
        {
            session: "A1_CD_Full",
            fee: 1400,
            description: "A1全科",
            originalFee: 1600,
            discountedFee: 1400,
            isDiscounted: true  // ← 已应用折扣
        }
    ]
}
```

---

### 3.4 测试费用计算（有专属代码 + 单科）

**步骤：**
1. 保持专属代码验证状态
2. 选择单科考试（如 A1笔试）
3. 查看费用

```javascript
const feeResult = calculateTotalFee(checkedSessions);
console.log('单科费用（有专属代码）:', feeResult);
```

**✅ 预期结果（选择 A1笔试，有专属代码）：**
```javascript
{
    totalFee: 950,  // ← 仍使用原价
    details: [
        {
            session: "A1_CD_Written",
            fee: 950,
            description: "A1笔试",
            originalFee: 950,
            discountedFee: null,
            isDiscounted: false  // ← 单科不享受折扣
        }
    ]
}
```

**关键验证点：**
- ✅ 单科考试即使有专属代码也不享受折扣
- ✅ 使用原价

---

### 3.5 测试多科目组合（无价格上限限制）

**重要：验证已移除"单科总价超过全科时按全科价格收费"的限制**

**步骤：**
1. 选择多个单科，使总价超过全科价格
2. 例如：A1笔试(950) + A1口试(600) = 1550 元
3. 查看总价

```javascript
const feeResult = calculateTotalFee(['A1_CD_Written', 'A1_CD_Oral']);
console.log('多科组合费用:', feeResult);
console.log('总价:', feeResult.totalFee, '元');
console.log('A1全科价格:', 1600, '元');
console.log('是否超过全科:', feeResult.totalFee > 1400 ? '是，但仍按实际总和计算' : '否');
```

**✅ 预期结果：**
```javascript
{
    totalFee: 1550,  // ← 直接加总，不受全科价格限制
    details: [
        { session: "A1_CD_Written", fee: 950, ... },
        { session: "A1_CD_Oral", fee: 600, ... }
    ]
}
```

**关键验证点：**
- ✅ 总价 = 950 + 600 = 1550 元
- ✅ 虽然超过全科价格(1400/1600)，但仍按实际总和计算
- ✅ **已移除价格上限限制**

---

## ✅ 检查项 4：地点映射功能

### 4.1 检查城市配置

```javascript
// 查看所有支持的城市
console.log('支持的城市:', LOCATION_MAPPINGS);
console.log('城市数量:', Object.keys(LOCATION_MAPPINGS).length);
```

**✅ 预期结果：** 显示 11 个城市
```javascript
{
  'BJ': '北京',
  'CD': '成都',
  'GZ': '广州',
  'HZ': '杭州',
  'NJ': '南京',
  'QD': '青岛',
  'SH': '上海',
  'SZ': '深圳',
  'WX': '无锡',
  'XA': '西安',
  'ZZ': '郑州'
}
```

---

### 4.2 测试转换函数

```javascript
// 测试代码转中文
console.log('CD →', getLocationName('CD'));  // 成都
console.log('HZ →', getLocationName('HZ'));  // 杭州
console.log('NJ →', getLocationName('NJ'));  // 南京
console.log('WX →', getLocationName('WX'));  // 无锡
console.log('XA →', getLocationName('XA'));  // 西安
console.log('QD →', getLocationName('QD'));  // 青岛
console.log('ZZ →', getLocationName('ZZ'));  // 郑州

// 测试中文转代码
console.log('成都 →', getLocationCode('成都'));  // CD
console.log('杭州 →', getLocationCode('杭州'));  // HZ
console.log('南京 →', getLocationCode('南京'));  // NJ
```

**✅ 预期结果：** 所有转换都正确

---

### 4.3 检查页面显示

**如果数据库中有不同城市的场次：**
- 页面上应该显示中文城市名（不是代码）
- 例如：显示"杭州考场"而不是"HZ考场"

---

## ✅ 检查项 5：表单提交数据完整性

### 5.1 模拟表单提交

**步骤：**
1. 填写完整表单
2. 选择场次和科目
3. 输入并验证专属代码（可选）
4. 打开控制台
5. 点击"提交报名"

**在控制台查看提交的数据：**
```
📋 完整提交数据: {
    applicationID: "OSD123",
    firstName: "张",
    lastName: "三",
    ...
    examSessions: ["A1_CD_Full"],
    selectedVenues: ["成都"],
    examDate: "2025-11-22 (成都)",
    totalFee: 1400,
    feeDetails: [...],
    couponCode: "TEST2025",      // ← 有专属代码
    couponApplied: true,          // ← 已应用专属代码
    ...
}
```

**✅ 必须包含的字段：**
- [ ] `couponCode`: 专属代码（如果验证成功）
- [ ] `couponApplied`: 是否应用专属代码
- [ ] `totalFee`: 总费用（折后价或原价）
- [ ] `feeDetails`: 费用明细数组
- [ ] `examDate`: 考试日期（包含城市中文名）
- [ ] `selectedVenues`: 选中的场次（中文名）

---

## 📊 完整检查清单总结

### 数据库连接功能
- [ ] Supabase 配置正确
- [ ] 场次数据成功加载
- [ ] 产品数据成功加载
- [ ] 动态渲染场次选择
- [ ] 动态渲染产品选项
- [ ] is_active 字段控制场次显示

### 专属代码功能
- [ ] UI 元素完整（输入框、按钮、状态区）
- [ ] 验证函数存在并可用
- [ ] 未选场次时提示错误
- [ ] 空代码时提示错误
- [ ] 错误代码时提示错误
- [ ] 正确代码时验证成功
- [ ] 验证成功后 validatedCoupon 有值
- [ ] 专属代码与价格正确联动

### 价格调整功能
- [ ] 产品价格单位为"分"
- [ ] 全科考试有折后价（200元折扣）
- [ ] 单科考试无折扣
- [ ] 无专属代码时使用原价
- [ ] 有专属代码 + 全科 = 折后价
- [ ] 有专属代码 + 单科 = 原价（无折扣）
- [ ] 多科组合直接加总（无价格上限）
- [ ] 费用明细显示折扣信息

### 地点映射功能
- [ ] 支持 11 个城市
- [ ] getLocationName() 函数正常
- [ ] getLocationCode() 函数正常
- [ ] 页面显示中文城市名
- [ ] 无硬编码的城市判断

### 表单提交
- [ ] 提交数据包含专属代码信息
- [ ] 提交数据包含正确的费用
- [ ] 城市名称为中文
- [ ] 数据结构完整

---

## 🎯 快速验证脚本

**在控制台中一次性运行以下脚本，快速检查所有功能：**

```javascript
console.log('========== 功能检查开始 ==========');

// 1. 检查配置
console.log('\n1️⃣ 数据库配置:');
console.log('✓ Supabase URL:', SUPABASE_URL);
console.log('✓ Supabase Key:', SUPABASE_ANON_KEY ? '已配置' : '未配置');

// 2. 检查数据加载
console.log('\n2️⃣ 数据加载状态:');
console.log('✓ 场次数据:', examSessionsData.length, '个');
console.log('✓ 产品数据:', examProductsData.length, '个');

// 3. 检查函数
console.log('\n3️⃣ 关键函数:');
console.log('✓ renderExamSessions:', typeof renderExamSessions);
console.log('✓ renderExamProducts:', typeof renderExamProducts);
console.log('✓ validateCouponCode:', typeof validateCouponCode);
console.log('✓ calculateTotalFee:', typeof calculateTotalFee);
console.log('✓ getLocationName:', typeof getLocationName);
console.log('✓ getLocationCode:', typeof getLocationCode);

// 4. 检查城市映射
console.log('\n4️⃣ 城市映射:');
console.log('✓ 支持城市数量:', Object.keys(LOCATION_MAPPINGS).length);
console.table(LOCATION_MAPPINGS);

// 5. 检查价格结构
console.log('\n5️⃣ 价格结构示例:');
const fullCourse = examProductsData.find(p => p.module_type === 'Full');
if (fullCourse) {
    console.log('✓ 全科示例:', fullCourse.name);
    console.log('  - 原价:', fullCourse.price_original / 100, '元');
    console.log('  - 折后价:', fullCourse.price_discounted / 100, '元');
}
const singleCourse = examProductsData.find(p => p.module_type !== 'Full');
if (singleCourse) {
    console.log('✓ 单科示例:', singleCourse.name);
    console.log('  - 原价:', singleCourse.price_original / 100, '元');
    console.log('  - 折后价:', singleCourse.price_discounted || '无折扣');
}

// 6. 检查 UI 元素
console.log('\n6️⃣ UI 元素:');
console.log('✓ 专属代码输入框:', document.getElementById('couponCode') ? '存在' : '不存在');
console.log('✓ 验证按钮:', document.getElementById('validateCouponBtn') ? '存在' : '不存在');
console.log('✓ 状态显示:', document.getElementById('couponStatus') ? '存在' : '不存在');

// 7. 检查状态变量
console.log('\n7️⃣ 全局状态:');
console.log('✓ validatedCoupon:', validatedCoupon || '未验证');
console.log('✓ selectedSessionId:', selectedSessionId || '未选择');

console.log('\n========== 功能检查完成 ==========');
console.log('\n💡 提示: 如果所有项都显示正确，说明功能实现完整！');
```

---

## 🚨 常见问题

### 问题 1：控制台报错 "LOCATION_MAPPINGS is not defined"
**原因：** script.js 未正确加载  
**解决：** 刷新页面，确保 script.js 文件路径正确

### 问题 2：场次数据为空
**原因：** 数据库中没有 is_active=true 的场次  
**解决：** 在 Supabase 中检查数据

### 问题 3：专属代码验证一直失败
**原因：** 数据库中没有对应的专属代码或 session_id 不匹配  
**解决：** 检查数据库 coupons 表

---

## ✅ 验证完成标志

如果以下所有项都通过，说明所有功能已正确实现：

1. ✅ 控制台显示数据加载成功日志
2. ✅ 快速验证脚本无错误
3. ✅ 城市映射显示 11 个城市
4. ✅ 可以选择场次和科目
5. ✅ 专属代码可以验证（有测试数据时）
6. ✅ 费用计算正确（有/无折扣）
7. ✅ 多科目直接加总（无上限）
8. ✅ 表单可以提交并数据完整

---

**祝检查顺利！** 如有任何问题，请告知具体的错误信息。🎉
