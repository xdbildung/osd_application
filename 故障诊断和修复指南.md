# 🔧 前端无法调取数据库 - 故障诊断和修复指南

## 📅 诊断时间：2026-01-12

---

## 🚨 问题描述

**症状**：访问 https://osd.talentdual.com/ 时，前端页面无法从数据库加载考试场次数据

**影响**：用户无法看到可选的考试场次和科目

---

## ✅ 已发现的问题和修复

### 问题 1：Vercel 配置错误 ⚠️

**根本原因**：
- `vercel.json` 中将所有 `*.js` 文件配置为静态文件（`@vercel/static`）
- 导致 `/api/supabase.js` 无法作为 Serverless Function 运行
- API 请求返回静态文件内容而不是执行代码

**修复状态**：✅ 已修复
- 移除了 `builds` 配置
- Vercel 现在会自动识别 `/api` 目录下的文件为 Serverless Functions

### 问题 2：缺少 CORS 配置 ⚠️

**根本原因**：
- API 代理没有设置 CORS 响应头
- 浏览器可能阻止跨域请求

**修复状态**：✅ 已修复
- 添加了 CORS 响应头
- 支持 OPTIONS 预检请求

---

## 🔍 需要您验证的配置

### 步骤 1：检查 Vercel 环境变量（关键！）⭐

这是**最可能**导致问题的原因。

#### 操作步骤：

1. **登录 Vercel Dashboard**
   - 访问：https://vercel.com/dashboard
   - 找到项目：`osd_application`

2. **检查环境变量**
   - 点击项目 → `Settings` → `Environment Variables`
   - 确认以下变量存在：

   | 变量名 | 预期值 | 环境 |
   |--------|--------|------|
   | `SUPABASE_URL` | `https://totxnqrbgvppdrziynpz.supabase.co` | ✅ Production<br>✅ Preview<br>✅ Development |
   | `SUPABASE_ANON_KEY` | `sb_publishable_j9PE3FzvHbAzDOoBgr1NZw_zEw7MksE` | ✅ Production<br>✅ Preview<br>✅ Development |

3. **常见错误检查**：
   - ❌ 变量名拼写错误（区分大小写！）
   - ❌ 只添加到 Development，没有添加到 Production
   - ❌ 值前后有多余的空格
   - ❌ 使用了错误的 Key（要用 anon key，不是 service_role key）

#### 如何添加/修正环境变量：

```
1. 点击 "Add New" 或点击已有变量旁的 "Edit"
2. 变量名：SUPABASE_URL
3. 值：https://totxnqrbgvppdrziynpz.supabase.co
4. 环境：勾选 Production, Preview, Development 三个
5. 点击 "Save"
6. 对 SUPABASE_ANON_KEY 重复以上步骤
```

---

### 步骤 2：检查 Supabase RLS 策略

#### 操作步骤：

1. **登录 Supabase Dashboard**
   - 访问：https://supabase.com/dashboard
   - 选择项目：`totxnqrbgvppdrziynpz`

2. **验证 RLS 策略**
   - 左侧菜单：`Authentication` → `Policies`
   - 或：`Database` → `Tables` → 点击表名 → `Policies` 标签

3. **预期配置**：

   **exam_sessions 表**：
   - ✅ RLS Enabled: ON
   - ✅ Policy: "Allow public read access to exam_sessions" (SELECT)

   **exam_products 表**：
   - ✅ RLS Enabled: ON
   - ✅ Policy: "Allow public read access to exam_products" (SELECT)

   **coupons 表**：
   - ✅ RLS Enabled: ON
   - ✅ Policy: "Allow public read access to coupons" (SELECT)

4. **测试 RLS**：
   - 进入 `SQL Editor`
   - 执行：
   ```sql
   SELECT * FROM exam_sessions LIMIT 5;
   ```
   - **预期结果**：返回数据（不是权限错误）

#### 如果 RLS 未配置或配置错误：

```sql
-- 在 Supabase SQL Editor 中执行以下 SQL

-- 1. 启用 RLS
ALTER TABLE exam_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE exam_products ENABLE ROW LEVEL SECURITY;
ALTER TABLE coupons ENABLE ROW LEVEL SECURITY;

-- 2. 删除旧策略（如果存在）
DROP POLICY IF EXISTS "Allow public read access to exam_sessions" ON exam_sessions;
DROP POLICY IF EXISTS "Allow public read access to exam_products" ON exam_products;
DROP POLICY IF EXISTS "Allow public read access to coupons" ON coupons;

-- 3. 创建新策略
CREATE POLICY "Allow public read access to exam_sessions" 
ON exam_sessions FOR SELECT USING (true);

CREATE POLICY "Allow public read access to exam_products" 
ON exam_products FOR SELECT USING (true);

CREATE POLICY "Allow public read access to coupons" 
ON coupons FOR SELECT USING (true);

-- 4. 验证
SELECT * FROM exam_sessions LIMIT 5;
```

---

### 步骤 3：重新部署 Vercel 项目（必须！）⭐

**重要**：修改环境变量或配置文件后，必须重新部署才能生效！

#### 操作步骤：

1. **触发重新部署**
   - Vercel Dashboard → 项目 → `Deployments` 标签
   - 找到最新的部署
   - 点击右侧 `...` 菜单 → `Redeploy`
   - 或者：推送新的 Git 提交会自动触发部署

2. **等待部署完成**
   - 通常需要 1-3 分钟
   - 状态从 "Building" → "Ready"

3. **检查部署日志**
   - 点击部署 → `Functions` 标签
   - 查找 `api/supabase` 函数
   - 如果看到函数列表，说明配置正确 ✅

---

## 🧪 测试和验证

### 测试 1：浏览器控制台测试 API 代理

1. 访问：https://osd.talentdual.com/
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 粘贴以下代码并执行：

```javascript
fetch('/api/supabase', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        table: 'exam_sessions',
        options: { select: '*', limit: 3 }
    })
})
.then(res => {
    console.log('状态码:', res.status);
    return res.json();
})
.then(data => {
    console.log('✅ API 响应:', data);
    if (Array.isArray(data) && data.length > 0) {
        console.log('✅ 成功！返回了', data.length, '条数据');
    } else {
        console.log('⚠️ API 工作但没有数据');
    }
})
.catch(err => {
    console.error('❌ API 错误:', err);
});
```

**预期结果**：
```
状态码: 200
✅ API 响应: [{ id: 1, session_code: "A1_CD_Full", ... }, ...]
✅ 成功！返回了 3 条数据
```

**如果看到错误**：

| 错误 | 原因 | 解决方法 |
|------|------|---------|
| `500` - "Supabase credentials not configured" | 环境变量未配置 | 返回"步骤 1"配置环境变量 |
| `403` - "Access to table ... is not allowed" | 表名不在白名单 | 检查拼写，确认是 `exam_sessions` |
| `404` - Not Found | API 路由未生效 | 确认已重新部署 |
| `Failed to fetch` | CORS 或网络问题 | 检查网络，清除浏览器缓存 |

---

### 测试 2：检查 Network 请求

1. 开发者工具 → `Network` 标签
2. 刷新页面（`F5`）
3. 找到 `/api/supabase` 请求
4. 点击查看详情：

**正常情况**：
- Status: `200 OK`
- Type: `fetch` 或 `xhr`
- Response: JSON 数组数据

**异常情况**：
- Status: `500` → 检查环境变量
- Status: `403` → 检查 Supabase RLS
- Status: `404` → 检查 Vercel 配置和部署

---

### 测试 3：直接访问 API 端点

在浏览器地址栏访问：
```
https://osd.talentdual.com/api/supabase
```

**预期结果**：
```json
{
  "error": "Method not allowed",
  "message": "Only POST requests are allowed"
}
```

这表示 API 端点存在且正常响应（只是不接受 GET 请求）。

**如果看到**：
- `404 Not Found` → API 路由未部署
- `502 Bad Gateway` → Serverless Function 执行错误
- 页面显示源代码 → `vercel.json` 配置错误（应该已修复）

---

## 📋 完整排查清单

按顺序检查以下项目：

### A. Git 和部署
- [ ] 最新代码已推送到 GitHub
- [ ] Vercel 已连接到 GitHub 仓库
- [ ] Vercel 已触发最新部署
- [ ] 部署状态显示 "Ready"

### B. Vercel 配置
- [ ] 环境变量 `SUPABASE_URL` 已添加（所有环境）
- [ ] 环境变量 `SUPABASE_ANON_KEY` 已添加（所有环境）
- [ ] 变量名拼写完全正确（区分大小写）
- [ ] 值前后没有多余空格
- [ ] 已重新部署项目

### C. Supabase 配置
- [ ] `exam_sessions` 表 RLS 已启用
- [ ] `exam_products` 表 RLS 已启用
- [ ] `coupons` 表 RLS 已启用
- [ ] 每个表都有 SELECT 策略
- [ ] SQL 测试查询返回数据

### D. 功能测试
- [ ] API 端点可访问（返回 405 Method not allowed）
- [ ] 浏览器控制台测试返回数据
- [ ] Network 显示 `/api/supabase` 请求成功
- [ ] 前端页面显示考试场次数据

---

## 🚀 快速修复流程（推荐）

如果您不确定哪里出错，按以下顺序操作：

### 1️⃣ 推送修复的代码（2分钟）

```bash
# 在项目目录执行
git add .
git commit -m "fix: update Vercel config for Serverless Functions and add CORS"
git push origin main
```

### 2️⃣ 确认环境变量（3分钟）

1. Vercel Dashboard → 项目 → Settings → Environment Variables
2. 添加或确认：
   - `SUPABASE_URL` = `https://totxnqrbgvppdrziynpz.supabase.co`
   - `SUPABASE_ANON_KEY` = `sb_publishable_j9PE3FzvHbAzDOoBgr1NZw_zEw7MksE`
3. 确保两个变量都勾选了 Production, Preview, Development

### 3️⃣ 重新部署（1分钟）

1. Vercel Dashboard → 项目 → Deployments
2. 最新部署 → `...` → Redeploy
3. 等待部署完成（显示 "Ready"）

### 4️⃣ 验证 RLS（2分钟）

1. Supabase Dashboard → SQL Editor
2. 执行：
```sql
SELECT * FROM exam_sessions LIMIT 5;
```
3. 确认返回数据（不是权限错误）

### 5️⃣ 测试网站（1分钟）

1. 访问：https://osd.talentdual.com/
2. 按 F12 打开控制台
3. 应该看到：
```
✅ 成功加载 X 个考试场次
```

---

## 🆘 如果问题仍未解决

### 方案 A：查看详细错误日志

1. **Vercel Function Logs**
   - Vercel Dashboard → 项目 → Deployments → 最新部署
   - 点击 `Functions` 标签
   - 点击 `api/supabase` 查看日志
   - 查找错误信息

2. **浏览器控制台错误**
   - F12 → Console 标签
   - 查找红色错误信息
   - 截图并记录

### 方案 B：验证 Supabase 连接

在 Supabase SQL Editor 中执行：

```sql
-- 检查表是否存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('exam_sessions', 'exam_products', 'coupons');

-- 检查 RLS 状态
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('exam_sessions', 'exam_products', 'coupons');

-- 检查策略
SELECT * FROM pg_policies 
WHERE schemaname = 'public' 
AND tablename IN ('exam_sessions', 'exam_products', 'coupons');
```

### 方案 C：临时禁用 RLS 测试

⚠️ **警告**：仅用于测试，测试后立即重新启用！

```sql
-- 临时禁用 RLS
ALTER TABLE exam_sessions DISABLE ROW LEVEL SECURITY;

-- 在浏览器测试 API 是否工作

-- 测试完成后立即重新启用
ALTER TABLE exam_sessions ENABLE ROW LEVEL SECURITY;
```

---

## 📞 需要支持？

如果以上步骤都无法解决问题，请提供以下信息：

1. **Vercel 部署日志截图**
   - Functions 标签的错误信息

2. **浏览器控制台截图**
   - Console 和 Network 标签的错误

3. **Supabase SQL 测试结果**
   - `SELECT * FROM exam_sessions LIMIT 5;` 的输出

4. **Vercel 环境变量截图**
   - 确认变量名和环境选择（隐藏实际值）

---

## ✅ 问题解决确认

完成修复后，确认以下所有项目：

- [ ] ✅ API 端点测试返回数据
- [ ] ✅ 浏览器控制台无错误
- [ ] ✅ Network 显示 `/api/supabase` 状态 200
- [ ] ✅ 网站显示考试场次列表
- [ ] ✅ 可以选择考试科目
- [ ] ✅ 提交报名功能正常

---

**更新时间**：2026-01-12  
**修复状态**：🔄 代码已修复，等待部署和配置验证
