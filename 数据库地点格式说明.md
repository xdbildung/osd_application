# 数据库地点格式说明

## 🎯 重要：统一地点格式

### ✅ 正确的格式

数据库中的 **所有地点字段** 都应该使用 **代码格式**（2个大写字母）：

| 代码 | 中文名称 |
|------|---------|
| CD   | 成都     |
| BJ   | 北京     |
| SH   | 上海     |
| GZ   | 广州     |
| SZ   | 深圳     |
| HZ   | 杭州     |
| NJ   | 南京     |
| WX   | 无锡     |
| XA   | 西安     |
| QD   | 青岛     |
| ZZ   | 郑州     |

---

## 📋 需要检查的表

### 1. `exam_sessions` 表

**字段**: `location`

**✅ 正确格式**:
```sql
INSERT INTO exam_sessions (date, location, levels, is_active, is_active_until) VALUES
    ('2026-03-15', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-03-08'),  -- ✅ 使用 'CD'
    ('2026-06-20', 'BJ', ARRAY['A1', 'A2', 'B1'], true, '2026-06-13'),  -- ✅ 使用 'BJ'
    ('2026-09-10', 'SH', ARRAY['A1', 'A2'], true, '2026-09-03');        -- ✅ 使用 'SH'
```

**❌ 错误格式**:
```sql
INSERT INTO exam_sessions (date, location, levels, is_active, is_active_until) VALUES
    ('2026-03-15', '成都', ARRAY['A1', 'A2', 'B1'], true, '2026-03-08'),  -- ❌ 不要用中文
    ('2026-06-20', '北京', ARRAY['A1', 'A2', 'B1'], true, '2026-06-13');  -- ❌ 不要用中文
```

---

### 2. `exam_products` 表

**字段**: `location`

**✅ 正确格式**:
```sql
INSERT INTO exam_products (code, name, level, location, module_type, price_original, price_discounted, is_active) VALUES
    ('A1_CD_Full', 'A1全科', 'A1', 'CD', 'Full', 160000, 140000, true),      -- ✅ 使用 'CD'
    ('A1_BJ_Full', 'A1全科', 'A1', 'BJ', 'Full', 160000, 140000, true),      -- ✅ 使用 'BJ'
    ('A1_SH_Full', 'A1全科', 'A1', 'SH', 'Full', 160000, 140000, true);      -- ✅ 使用 'SH'
```

**❌ 错误格式**:
```sql
INSERT INTO exam_products (code, name, level, location, module_type, price_original, price_discounted, is_active) VALUES
    ('A1_CD_Full', 'A1全科', 'A1', '成都', 'Full', 160000, 140000, true),    -- ❌ 不要用中文
    ('A1_BJ_Full', 'A1全科', 'A1', '北京', 'Full', 160000, 140000, true);    -- ❌ 不要用中文
```

---

## 🔍 检查数据库中的格式

### 步骤 1：检查 `exam_sessions` 表

在 Supabase SQL Editor 中运行：

```sql
SELECT id, date, location, levels, is_active 
FROM exam_sessions 
ORDER BY date;
```

**检查 `location` 列：**
- ✅ 应该显示：`CD`, `BJ`, `SH` 等代码
- ❌ 如果显示：`成都`, `北京`, `上海` 等中文，需要修复

---

### 步骤 2：检查 `exam_products` 表

```sql
SELECT code, name, level, location, module_type, price_original 
FROM exam_products 
WHERE is_active = true 
ORDER BY location, level, module_type;
```

**检查 `location` 列：**
- ✅ 应该显示：`CD`, `BJ`, `SH` 等代码
- ❌ 如果显示：`成都`, `北京`, `上海` 等中文，需要修复

---

## 🔧 如何修复数据

### 情况 1：如果 `exam_sessions` 表中是中文

```sql
-- 更新为代码格式
UPDATE exam_sessions 
SET location = CASE 
    WHEN location = '成都' THEN 'CD'
    WHEN location = '北京' THEN 'BJ'
    WHEN location = '上海' THEN 'SH'
    WHEN location = '广州' THEN 'GZ'
    WHEN location = '深圳' THEN 'SZ'
    WHEN location = '杭州' THEN 'HZ'
    WHEN location = '南京' THEN 'NJ'
    WHEN location = '无锡' THEN 'WX'
    WHEN location = '西安' THEN 'XA'
    WHEN location = '青岛' THEN 'QD'
    WHEN location = '郑州' THEN 'ZZ'
    ELSE location
END;

-- 验证更新
SELECT id, date, location FROM exam_sessions ORDER BY date;
```

---

### 情况 2：如果 `exam_products` 表中是中文

```sql
-- 更新为代码格式
UPDATE exam_products 
SET location = CASE 
    WHEN location = '成都' THEN 'CD'
    WHEN location = '北京' THEN 'BJ'
    WHEN location = '上海' THEN 'SH'
    WHEN location = '广州' THEN 'GZ'
    WHEN location = '深圳' THEN 'SZ'
    WHEN location = '杭州' THEN 'HZ'
    WHEN location = '南京' THEN 'NJ'
    WHEN location = '无锡' THEN 'WX'
    WHEN location = '西安' THEN 'XA'
    WHEN location = '青岛' THEN 'QD'
    WHEN location = '郑州' THEN 'ZZ'
    ELSE location
END;

-- 验证更新
SELECT code, location, name FROM exam_products WHERE is_active = true ORDER BY location, level;
```

---

## 🎯 为什么要使用代码格式？

### 优点：

1. **一致性**
   - 数据库中统一使用代码
   - 前端根据需要显示中文或代码

2. **灵活性**
   - 容易扩展新城市
   - 多语言支持更容易

3. **简洁性**
   - 代码短小，节省存储空间
   - 避免中文编码问题

4. **标准化**
   - 符合国际惯例（如机场代码）
   - 便于国际化

---

## 🔄 前端自动转换

前端代码已经实现了自动转换：

### 代码 → 中文
```javascript
getLocationName('CD')  // 返回: '成都'
getLocationName('BJ')  // 返回: '北京'
```

### 中文 → 代码
```javascript
getLocationCode('成都')  // 返回: 'CD'
getLocationCode('北京')  // 返回: 'BJ'
```

### 自动识别
```javascript
// 如果已经是代码，保持不变
getLocationName('CD')  // 返回: '成都'
// 如果已经是中文，保持不变
getLocationName('成都')  // 返回: '成都'
```

---

## ✅ 验证清单

修复数据后，请验证：

- [ ] `exam_sessions.location` 都是代码格式（如 'CD', 'BJ'）
- [ ] `exam_products.location` 都是代码格式（如 'CD', 'BJ'）
- [ ] 产品代码 `code` 也使用地点代码（如 'A1_CD_Full', 'A1_BJ_Full'）
- [ ] 前端可以正确显示中文城市名
- [ ] 场次选择显示正确的城市名称
- [ ] 科目选择显示正确的城市名称

---

## 🧪 测试步骤

### 1. 在控制台测试地点转换

```javascript
// 测试转换函数
console.log('CD →', getLocationName('CD'));  // 应该显示: 成都
console.log('BJ →', getLocationName('BJ'));  // 应该显示: 北京
console.log('SH →', getLocationName('SH'));  // 应该显示: 上海
```

### 2. 检查加载的数据

```javascript
// 查看场次数据的地点格式
console.log('场次数据:', examSessionsData);
examSessionsData.forEach(s => {
    console.log(`场次: ${s.date}, 地点代码: ${s.location}, 中文: ${getLocationName(s.location)}`);
});

// 查看产品数据的地点格式
console.log('产品数据:', examProductsData);
examProductsData.forEach(p => {
    console.log(`产品: ${p.code}, 地点代码: ${p.location}`);
});
```

### 3. 测试场次显示

刷新页面后，场次列表应该显示：
```
☐ 成都考场
  考试日期：2026年03月15日
  
☐ 北京考场
  考试日期：2026年06月20日
  
☐ 上海考场
  考试日期：2026年09月10日
```

而不是：
```
☐ CD考场  ← 错误
☐ BJ考场  ← 错误
```

---

## 📝 总结

**数据库规范：**
- ✅ 所有 `location` 字段使用代码格式（CD, BJ, SH 等）
- ✅ 产品 `code` 中的地点部分也使用代码（A1_CD_Full, A1_BJ_Full 等）

**前端显示：**
- ✅ 自动转换为中文显示
- ✅ 使用 `getLocationName()` 函数转换
- ✅ 支持新增城市（只需在 LOCATION_MAPPINGS 中添加）

**好处：**
- ✅ 数据一致性
- ✅ 易于扩展
- ✅ 避免编码问题
- ✅ 符合国际标准
