# 🧪 快速测试 - 场次和等级限制功能

## 🚀 启动测试

### 1. 启动服务器
```bash
python -m http.server 8000
```

### 2. 打开浏览器
```
http://localhost:8000/index.html
```

### 3. 按 F12 打开开发者工具

---

## ✅ 测试清单

### 测试 1：场次限制（只能选1天）

**操作步骤：**
1. 页面上应该显示多个考试场次
2. 勾选第一个场次
3. 观察其他场次

**✅ 预期结果：**
- 其他场次的复选框被禁用（灰色）
- 鼠标悬停显示"不可点击"光标
- 只有选中的场次可以操作

**测试取消：**
4. 取消勾选第一个场次
5. 观察所有场次

**✅ 预期结果：**
- 所有场次恢复正常
- 可以重新选择任意场次

---

### 测试 2：等级限制（只能选1个等级）

**操作步骤：**
1. 选择一个场次
2. 展开考试科目选项
3. 勾选"A1全科"
4. 观察 A2 和 B1 等级的选项

**✅ 预期结果：**
- A2 和 B1 等级的所有选项被禁用（灰色）
- 只有 A1 等级的选项可以操作

**测试取消：**
5. 取消勾选"A1全科"
6. 观察所有等级

**✅ 预期结果：**
- 所有等级恢复正常
- 可以选择任意等级

---

### 测试 3：全科/单科互斥（保持原有逻辑）

**测试 3.1：全科禁用单科**
1. 选择"A1全科"
2. 观察"A1笔试"和"A1口试"

**✅ 预期结果：**
- A1 单科选项被禁用
- A1 单科选项变灰

**测试 3.2：单科禁用全科**
1. 取消"A1全科"
2. 勾选"A1笔试"
3. 勾选"A1口试"
4. 观察"A1全科"

**✅ 预期结果：**
- 如果所有单科都选中，全科被禁用
- 全科选项变灰

---

### 测试 4：报名截止日期显示

**前提条件：**
- 数据库中的场次有 `is_active_until` 字段值

**操作步骤：**
1. 查看场次列表
2. 每个场次下方应该显示信息

**✅ 预期结果：**
```
□ 成都考场
  考试日期：2026年03月15日
  报名截止：2026年03月08日  ← 橙色显示
```

**如果没有显示：**
- 检查数据库中是否有 `is_active_until` 值
- 在控制台执行：
```javascript
console.log('场次数据:', examSessionsData);
// 查看是否有 is_active_until 字段
```

---

### 测试 5：提交后截止日期动态更新

**操作步骤：**
1. 选择一个场次（确保有报名截止日期）
2. 选择考试科目
3. 填写完整表单
4. 提交报名
5. 查看"重要提醒"部分

**✅ 预期结果：**
- "确定时限"显示的日期应该是所选场次的报名截止日期
- 例如：`请务必在2026年03月08日前完成所有确认步骤`

**在控制台验证：**
```javascript
// 查看选中的场次
const selectedVenue = document.querySelector('input[name="selectedVenues"]:checked');
console.log('报名截止日期:', selectedVenue?.dataset.deadline);
```

---

## 🎯 组合测试场景

### 场景 1：完整报名流程

**步骤：**
1. ✅ 选择场次（其他场次禁用）
2. ✅ 选择 A1 等级（其他等级禁用）
3. ✅ 选择全科（单科禁用）
4. ✅ 输入专属代码并验证
5. ✅ 填写个人信息
6. ✅ 提交表单
7. ✅ 查看截止日期是否正确

---

### 场景 2：更改选择

**步骤：**
1. ✅ 选择场次 A
2. ✅ 选择 A1 全科
3. ✅ 取消 A1 全科
4. ✅ 选择 A1 笔试 + A1 口试
5. ✅ 观察全科是否被禁用
6. ✅ 取消所有 A1 选择
7. ✅ 选择 A2 全科
8. ✅ 观察 A1 是否被禁用

---

### 场景 3：多场次切换

**步骤：**
1. ✅ 选择场次 A
2. ✅ 选择考试科目
3. ✅ 取消场次 A
4. ✅ 选择场次 B
5. ✅ 观察科目是否被清空
6. ✅ 重新选择科目

---

## 🗄️ 数据库准备

### 如果没有测试数据，在 Supabase 中执行：

```sql
-- 1. 添加字段（如果还没有）
ALTER TABLE exam_sessions 
ADD COLUMN IF NOT EXISTS is_active_until DATE;

-- 2. 更新现有数据
UPDATE exam_sessions 
SET is_active_until = date - INTERVAL '7 days'
WHERE is_active_until IS NULL;

-- 3. 或者插入测试数据
INSERT INTO exam_sessions (date, location, levels, is_active, is_active_until) VALUES
    ('2026-03-15', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-03-08'),
    ('2026-06-20', 'CD', ARRAY['A1', 'A2', 'B1'], true, '2026-06-13'),
    ('2026-09-10', 'BJ', ARRAY['A1', 'A2'], true, '2026-09-03')
ON CONFLICT DO NOTHING;

-- 4. 验证数据
SELECT id, date, location, is_active_until 
FROM exam_sessions 
WHERE is_active = true
ORDER BY date;
```

---

## 🐛 问题排查

### 问题 1：场次没有被禁用

**检查：**
```javascript
// 在控制台执行
const allVenues = document.querySelectorAll('input[name="selectedVenues"]');
console.log('场次数量:', allVenues.length);
allVenues.forEach((v, i) => {
    console.log(`场次${i+1}:`, {
        value: v.value,
        disabled: v.disabled,
        checked: v.checked
    });
});
```

---

### 问题 2：等级没有被禁用

**检查：**
```javascript
// 在控制台执行
const allExams = document.querySelectorAll('input[name="examSessions"]');
console.log('考试科目数量:', allExams.length);
allExams.forEach(e => {
    console.log({
        value: e.value,
        level: e.dataset.level,
        disabled: e.disabled,
        checked: e.checked
    });
});
```

---

### 问题 3：报名截止日期没有显示

**检查：**
```javascript
// 在控制台执行
console.log('场次数据:', examSessionsData);
examSessionsData.forEach(s => {
    console.log({
        location: s.location,
        date: s.date,
        is_active_until: s.is_active_until  // ← 检查这个字段
    });
});
```

**如果 `is_active_until` 为 null：**
- 在 Supabase 中更新数据
- 刷新页面

---

### 问题 4：提交后截止日期没有更新

**检查：**
```javascript
// 提交成功后，在控制台执行
const deadlineElement = document.getElementById('deadlineReminder');
console.log('截止日期元素:', deadlineElement);
console.log('内容:', deadlineElement?.innerHTML);

// 检查选中的场次
const selectedVenue = document.querySelector('input[name="selectedVenues"]:checked');
console.log('选中场次的截止日期:', selectedVenue?.dataset.deadline);
```

---

## ✅ 完整测试脚本

**在控制台中一次性运行：**

```javascript
console.log('========== 新功能测试 ==========\n');

// 1. 检查场次数据
console.log('1️⃣ 场次数据:');
console.log('场次数量:', examSessionsData.length);
if (examSessionsData.length > 0) {
    console.log('第一个场次:', {
        date: examSessionsData[0].date,
        location: examSessionsData[0].location,
        is_active_until: examSessionsData[0].is_active_until
    });
}

// 2. 检查场次元素
console.log('\n2️⃣ 场次元素:');
const venues = document.querySelectorAll('input[name="selectedVenues"]');
console.log('场次元素数量:', venues.length);

// 3. 检查考试科目元素
console.log('\n3️⃣ 考试科目元素:');
const exams = document.querySelectorAll('input[name="examSessions"]');
console.log('科目元素数量:', exams.length);

// 4. 检查截止日期元素
console.log('\n4️⃣ 截止日期元素:');
const deadlineElement = document.getElementById('deadlineReminder');
console.log('截止日期提醒元素:', deadlineElement ? '存在' : '不存在');

// 5. 模拟选择测试
console.log('\n5️⃣ 模拟选择测试:');
if (venues.length > 0) {
    console.log('尝试选择第一个场次...');
    venues[0].click();
    
    setTimeout(() => {
        console.log('检查其他场次是否被禁用:');
        venues.forEach((v, i) => {
            if (i > 0) {
                console.log(`场次${i+1} 禁用状态:`, v.disabled);
            }
        });
    }, 500);
}

console.log('\n========== 测试完成 ==========');
```

---

## 📊 预期测试结果

### 全部通过的标志：

- ✅ 选择场次后，其他场次被禁用
- ✅ 选择等级后，其他等级被禁用
- ✅ 全科和单科互斥正常
- ✅ 场次列表显示报名截止日期
- ✅ 提交后截止日期动态更新
- ✅ 控制台无错误

---

**祝测试顺利！** 🎉

如有任何问题，请查看控制台错误信息或参考《新功能说明-场次和等级限制.md》。
