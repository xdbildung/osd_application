# 修复说明 - 场次禁用和单科费用优化

## 🐛 修复的问题

### 问题 1：场次禁用展示逻辑未生效

**问题描述：**
- 选中第一个场次后，其他场次应该被禁用
- 但实际上其他场次仍然可以被选择
- 导致可以同时选择多个场次

**原因分析：**
- 虽然设置了 `disabled = true`，但没有阻止点击事件
- 需要同时设置 `pointer-events: none` 来完全禁用交互

**解决方案：**
```javascript
// 禁用其他场次时
if (cb !== checkbox && !cb.disabled) {
    // 1. 取消其他场次的选中状态
    if (cb.checked) {
        cb.checked = false;
        cb.closest('.session-option').classList.remove('selected');
    }
    // 2. 禁用checkbox
    cb.disabled = true;
    // 3. 更新样式
    const sessionOption = cb.closest('.session-option');
    sessionOption.style.opacity = '0.5';
    sessionOption.style.cursor = 'not-allowed';
    sessionOption.style.pointerEvents = 'none';  // ← 关键：阻止所有鼠标事件
}
```

---

### 问题 2：单科组合费用计算不正确

**问题描述：**
- 选择了某个等级的所有单科，应该按全科费用计算
- 但实际上是按单科加总计算
- 例如：A1笔试(950) + A1口试(600) = 1550元，应该按A1全科(1600元)计算

**各等级的单科组合规则：**
- **A1/A2**: 笔试 + 口试 = 全科
- **B1**: 听力 + 阅读 + 口语 + 写作 = 全科

**解决方案：**
添加 `checkAndConvertToFullCourse()` 函数，在计算费用前检查并转换：

```javascript
function checkAndConvertToFullCourse(examSessions) {
    // 1. 按等级和地点分组
    const levelMap = {};
    examSessions.forEach(code => {
        const product = examProductsData.find(p => p.code === code);
        const key = `${product.level}_${product.location}`;
        // 记录该等级选择了哪些模块
    });
    
    // 2. 检查每个等级是否选择了所有单科
    Object.keys(levelMap).forEach(key => {
        const { level, modules } = levelMap[key];
        
        let allModulesSelected = false;
        
        if (level === 'A1' || level === 'A2') {
            // A1/A2: Written + Oral = 全科
            allModulesSelected = 
                modules.includes('Written') && 
                modules.includes('Oral');
        } else if (level === 'B1') {
            // B1: Listening + Reading + Oral + Written = 全科
            allModulesSelected = 
                modules.includes('Listening') && 
                modules.includes('Reading') && 
                modules.includes('Oral') && 
                modules.includes('Written');
        }
        
        if (allModulesSelected) {
            // 替换为全科代码
            return fullCourseCode;
        }
    });
}
```

---

## ✅ 修复后的行为

### 场次选择行为

**场景 1：选择场次**
```
初始状态：
☐ 成都 - 2026年03月15日
☐ 成都 - 2026年06月20日
☐ 北京 - 2026年09月10日
☐ 杭州 - 2026年12月05日

选择第一个场次后：
☑ 成都 - 2026年03月15日  ← 可操作
☐ 成都 - 2026年06月20日  ← 灰色，不可点击
☐ 北京 - 2026年09月10日  ← 灰色，不可点击
☐ 杭州 - 2026年12月05日  ← 灰色，不可点击
```

**场景 2：取消选择**
```
取消第一个场次后：
☐ 成都 - 2026年03月15日  ← 恢复正常
☐ 成都 - 2026年06月20日  ← 恢复正常
☐ 北京 - 2026年09月10日  ← 恢复正常
☐ 杭州 - 2026年12月05日  ← 恢复正常
```

---

### 单科费用计算行为

**场景 1：A1 单科组合**

选择：
- ☑ A1笔试（原价950元）
- ☑ A1口试（原价600元）

计算逻辑：
```
检测到：Written + Oral
判定：所有单科已选中
转换：使用 A1全科费用
结果：1600元（而不是950+600=1550元）
```

控制台输出：
```
✅ 检测到A1等级所有单科已选中，自动转换为全科计算
```

---

**场景 2：A1 部分单科**

选择：
- ☑ A1笔试（950元）

计算逻辑：
```
检测到：仅 Written
判定：未选中所有单科
保持：使用单科费用
结果：950元
```

---

**场景 3：B1 单科组合**

选择：
- ☑ B1听力（600元）
- ☑ B1阅读（600元）
- ☑ B1口语（600元）
- ☑ B1写作（800元）

计算逻辑：
```
检测到：Listening + Reading + Oral + Written
判定：所有单科已选中
转换：使用 B1全科费用
结果：2000元（而不是600+600+600+800=2600元）
```

---

**场景 4：B1 部分单科**

选择：
- ☑ B1听力（600元）
- ☑ B1阅读（600元）

计算逻辑：
```
检测到：Listening + Reading
判定：未选中所有单科（还缺Oral和Written）
保持：使用单科费用
结果：1200元
```

---

## 🧪 测试步骤

### 测试 1：场次禁用

**步骤：**
1. 刷新页面
2. 查看所有场次
3. 点击选择第一个场次
4. 尝试点击其他场次

**✅ 预期结果：**
- 其他场次不可点击
- 鼠标悬停显示"禁止"光标
- 其他场次变灰（opacity: 0.5）

**步骤（继续）：**
5. 取消第一个场次的选择
6. 观察其他场次

**✅ 预期结果：**
- 所有场次恢复正常
- 可以重新选择任意场次

---

### 测试 2：A1单科费用

**步骤：**
1. 选择一个场次
2. 选择"A1笔试"
3. 查看费用（应该是950元）
4. 继续选择"A1口试"
5. 查看费用

**✅ 预期结果：**
- 费用显示：1600元（A1全科价格）
- 控制台显示：`✅ 检测到A1等级所有单科已选中，自动转换为全科计算`

**在控制台验证：**
```javascript
const checkedSessions = Array.from(document.querySelectorAll('input[name="examSessions"]:checked'))
    .map(cb => cb.value);
console.log('选中的科目:', checkedSessions);
// 应该显示: ["A1_CD_Written", "A1_CD_Oral"]

const feeResult = calculateTotalFee(checkedSessions);
console.log('费用计算:', feeResult);
// totalFee 应该是 1600，而不是 1550
```

---

### 测试 3：B1单科费用

**步骤：**
1. 选择一个场次
2. 依次选择：
   - B1听力
   - B1阅读
   - B1口语
3. 查看费用（应该是1800元）
4. 继续选择"B1写作"
5. 查看费用

**✅ 预期结果：**
- 选择3个单科时：1800元（600+600+600）
- 选择4个单科时：2000元（B1全科价格）
- 控制台显示：`✅ 检测到B1等级所有单科已选中，自动转换为全科计算`

---

### 测试 4：有专属代码的情况

**步骤：**
1. 选择场次
2. 输入并验证专属代码
3. 选择"A1笔试" + "A1口试"
4. 查看费用

**✅ 预期结果：**
- 费用显示：1400元（A1全科折后价）
- 说明专属代码折扣仍然有效

---

### 测试 5：混合等级（不应转换）

**步骤：**
1. 选择场次
2. 选择"A1笔试"
3. 取消A1选择
4. 选择"A2笔试"

**✅ 预期结果：**
- 每次只能选择一个等级
- 费用按实际选择计算，不会误转换

---

## 🔍 调试方法

### 方法 1：在控制台查看转换过程

```javascript
// 手动测试转换函数
const testSessions = ['A1_CD_Written', 'A1_CD_Oral'];
console.log('原始选择:', testSessions);

const processed = checkAndConvertToFullCourse(testSessions);
console.log('处理后:', processed);
// 应该显示: ['A1_CD_Full']

const result = calculateTotalFee(testSessions);
console.log('费用结果:', result);
// totalFee 应该是 1600
```

---

### 方法 2：监听费用计算

```javascript
// 在选择科目时查看实时计算
document.addEventListener('change', function(e) {
    if (e.target.name === 'examSessions') {
        const checked = Array.from(document.querySelectorAll('input[name="examSessions"]:checked'))
            .map(cb => cb.value);
        console.log('当前选择:', checked);
        
        const result = calculateTotalFee(checked);
        console.log('费用:', result.totalFee);
        console.log('明细:', result.details);
    }
});
```

---

### 方法 3：检查场次禁用状态

```javascript
// 查看所有场次的状态
const venues = document.querySelectorAll('input[name="selectedVenues"]');
venues.forEach((v, i) => {
    console.log(`场次${i+1}:`, {
        value: v.value,
        checked: v.checked,
        disabled: v.disabled,
        pointerEvents: v.closest('.session-option').style.pointerEvents
    });
});
```

---

## 📊 费用对照表

### A1 等级

| 选择组合 | 原计算 | 新计算 | 说明 |
|---------|--------|--------|------|
| 笔试 | 950元 | 950元 | 单科，不转换 |
| 口试 | 600元 | 600元 | 单科，不转换 |
| 笔试+口试 | 1550元 | **1600元** | ✅ 转换为全科 |
| 全科 | 1600元 | 1600元 | 直接使用全科 |

---

### A2 等级

| 选择组合 | 原计算 | 新计算 | 说明 |
|---------|--------|--------|------|
| 笔试 | 1000元 | 1000元 | 单科，不转换 |
| 口试 | 650元 | 650元 | 单科，不转换 |
| 笔试+口试 | 1650元 | **1700元** | ✅ 转换为全科 |
| 全科 | 1700元 | 1700元 | 直接使用全科 |

---

### B1 等级

| 选择组合 | 原计算 | 新计算 | 说明 |
|---------|--------|--------|------|
| 听力 | 600元 | 600元 | 单科，不转换 |
| 阅读 | 600元 | 600元 | 单科，不转换 |
| 口语 | 600元 | 600元 | 单科，不转换 |
| 写作 | 800元 | 800元 | 单科，不转换 |
| 听力+阅读 | 1200元 | 1200元 | 部分单科，不转换 |
| 听力+阅读+口语 | 1800元 | 1800元 | 部分单科，不转换 |
| 听力+阅读+口语+写作 | 2600元 | **2000元** | ✅ 转换为全科 |
| 全科 | 2000元 | 2000元 | 直接使用全科 |

---

## 💡 优化说明

### 为什么这样设计？

1. **符合实际业务逻辑**
   - 学生选择所有单科 = 全科考试
   - 应该按全科价格收费（更优惠）

2. **用户体验更好**
   - 学生可能不知道选单科组合等于全科
   - 系统自动识别并使用更优惠的价格

3. **展示逻辑保持不变**
   - 前端仍然显示选择的单科
   - 只是费用计算时自动转换
   - 用户可以清楚看到自己选择了什么

4. **专属代码仍然有效**
   - 转换为全科后，如果有专属代码，仍然使用折后价
   - 例如：A1笔试+口试 → A1全科(1600元) → 有专属代码(1400元)

---

## 📝 修改的代码位置

### 1. script.js 行 525-605
**场次选择逻辑**
- 添加 `pointer-events: none` 禁用交互
- 取消其他场次的选中状态
- 恢复时检查原始禁用状态

### 2. script.js 行 775-890
**费用计算逻辑**
- 添加 `checkAndConvertToFullCourse()` 函数
- 在计算费用前检查并转换单科组合
- 保持专属代码折扣逻辑不变

### 3. public/script.js
- 已同步更新

---

## ✅ 验证清单

完成测试后，确认以下项目：

- [ ] 选择场次后，其他场次确实不可点击
- [ ] 取消场次后，所有场次恢复正常
- [ ] A1笔试+口试 = 1600元（全科价）
- [ ] A2笔试+口试 = 1700元（全科价）
- [ ] B1四科 = 2000元（全科价）
- [ ] 部分单科仍按单科计算
- [ ] 有专属代码时折扣仍然有效
- [ ] 控制台显示转换提示信息
- [ ] 费用明细显示正确

---

**所有功能已修复！** 🎉

如果测试过程中发现任何问题，请查看控制台的调试信息。
